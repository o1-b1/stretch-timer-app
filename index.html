<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#F5F5F7" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#000000"  media="(prefers-color-scheme: dark)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Stretch">
  <title>Stretch</title>
  <link rel="manifest" href="manifest.json">
  <style>
    /* ‚îÄ‚îÄ DESIGN TOKENS ‚îÄ‚îÄ */
    :root {
      --bg:         #F5F5F7;
      --surface:    #FFFFFF;
      --surface2:   #E5E5EA;
      --text:       #000000;
      --text2:      #6E6E73;
      --border:     rgba(0,0,0,0.09);
      --accent:     #FF5F1F;
      --rest:       #34C759;
      --shadow:     0 2px 24px rgba(0,0,0,0.07);
      --tab-h:      49px;
      --r-lg:       24px;
      --r-md:       16px;
      --r-sm:       10px;
      --ff:         -apple-system, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
      --bg-glass:   rgba(245,245,247,0.82);
    }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) {
        --bg: #000000; --surface: #1C1C1E; --surface2: #2C2C2E;
        --text: #FFFFFF; --text2: #8E8E93; --border: rgba(255,255,255,0.10);
        --shadow: none; --bg-glass: rgba(0,0,0,0.88);
      }
    }
    :root[data-theme="dark"] {
      --bg: #000000; --surface: #1C1C1E; --surface2: #2C2C2E;
      --text: #FFFFFF; --text2: #8E8E93; --border: rgba(255,255,255,0.10);
      --shadow: none; --bg-glass: rgba(0,0,0,0.88);
    }
    :root[data-theme="light"] {
      --bg: #F5F5F7; --surface: #FFFFFF; --surface2: #E5E5EA;
      --text: #000000; --text2: #6E6E73; --border: rgba(0,0,0,0.09);
      --shadow: 0 2px 24px rgba(0,0,0,0.07); --bg-glass: rgba(245,245,247,0.82);
    }

    /* ‚îÄ‚îÄ RESET ‚îÄ‚îÄ */
    *, *::before, *::after {
      box-sizing: border-box; margin: 0; padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    html, body { height: 100%; }
    body {
      font-family: var(--ff);
      background: var(--bg);
      color: var(--text);
      overscroll-behavior: none;
      transition: background 0.3s, color 0.3s;
    }
    button { font-family: var(--ff); cursor: pointer; border: none; background: none; color: inherit; }
    select { font-family: var(--ff); }
    :focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
    .app {
      max-width: 430px;
      margin: 0 auto;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* ‚îÄ‚îÄ UPDATE BANNER ‚îÄ‚îÄ */
    #updateBanner {
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r-md);
      padding: 11px 16px;
      font-size: 0.82rem;
      font-weight: 500;
      margin: calc(env(safe-area-inset-top) + 8px) 16px 0;
      box-shadow: var(--shadow);
      position: sticky;
      top: calc(env(safe-area-inset-top) + 8px);
      z-index: 50;
    }
    #updateBanner.visible { display: flex; }
    #reloadBtn {
      background: var(--accent); color: #fff;
      border-radius: 8px; padding: 7px 14px;
      font-size: 0.78rem; font-weight: 700;
    }

    /* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
    .page {
      display: none;
      flex-direction: column;
      flex: 1;
      padding:
        calc(env(safe-area-inset-top) + 6px)
        20px
        calc(var(--tab-h) + env(safe-area-inset-bottom) + 28px);
      gap: 14px;
      overflow-y: auto;
    }
    .page.active { display: flex; }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 0 2px;
      flex-shrink: 0;
    }
    .wordmark {
      font-size: 1.45rem;
      font-weight: 800;
      letter-spacing: -0.04em;
      user-select: none;
    }
    .header-actions { display: flex; align-items: center; gap: 8px; }
    .remaining-pill {
      font-size: 0.7rem; font-weight: 600; color: var(--text2);
      background: var(--surface2); border-radius: 999px;
      padding: 5px 12px; font-variant-numeric: tabular-nums;
    }
    .icon-btn {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--surface2); font-size: 0.9rem;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    .icon-btn:active { transform: scale(0.86); }

    /* ‚îÄ‚îÄ MODE TOGGLE (segmented pill) ‚îÄ‚îÄ */
    .mode-toggle {
      display: grid; grid-template-columns: 1fr 1fr;
      background: var(--surface2); border-radius: 999px;
      padding: 3px; flex-shrink: 0;
    }
    .mode-btn {
      padding: 10px 8px; border-radius: 999px;
      font-size: 0.84rem; font-weight: 600; color: var(--text2);
      transition: background 0.22s ease, color 0.22s ease, box-shadow 0.22s ease;
      letter-spacing: -0.01em;
    }
    .mode-btn.active {
      background: var(--surface); color: var(--text);
      box-shadow: 0 1px 8px rgba(0,0,0,0.13);
    }

    /* ‚îÄ‚îÄ STEP INFO ‚îÄ‚îÄ */
    .step-info {
      text-align: center; flex-shrink: 0;
      min-height: 64px;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 4px;
    }
    .step-name {
      font-size: 1.45rem; font-weight: 700;
      letter-spacing: -0.03em; line-height: 1.15;
    }
    .step-meta { font-size: 0.8rem; color: var(--text2); font-weight: 500; }

    /* ‚îÄ‚îÄ RING HERO ‚îÄ‚îÄ */
    .ring-wrap {
      width: min(280px, 68vw); height: min(280px, 68vw);
      margin: 0 auto; flex-shrink: 0; position: relative;
    }
    .ring-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .ring-bg { fill: none; stroke: var(--surface2); stroke-width: 6; }
    .ring-fg {
      fill: none; stroke: var(--accent); stroke-width: 6;
      stroke-linecap: round; stroke-dasharray: 276.46; stroke-dashoffset: 0;
      transition: stroke 0.4s ease;
    }
    .ring-fg.rest-color { stroke: var(--rest); }
    .ring-center {
      position: absolute; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 2px;
    }
    .ring-time {
      font-size: clamp(3rem, 14vw, 4.4rem);
      font-weight: 700; letter-spacing: -0.05em;
      font-variant-numeric: tabular-nums; line-height: 1;
    }
    .ring-phase {
      font-size: 0.6rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.18em; color: var(--text2);
    }

    /* ‚îÄ‚îÄ STEP DOTS ‚îÄ‚îÄ */
    .dots {
      display: flex; gap: 6px;
      flex-wrap: wrap; justify-content: center;
      flex-shrink: 0; min-height: 16px;
    }
    .dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--surface2); cursor: pointer;
      transition: background 0.25s, transform 0.12s;
    }
    .dot:active { transform: scale(0.75); }
    .dot.done     { background: var(--accent); opacity: 0.4; }
    .dot.active   { background: var(--accent); }
    .dot.rest-active { background: var(--rest); }

    /* ‚îÄ‚îÄ PLAYBACK CONTROLS ‚îÄ‚îÄ */
    .controls {
      display: flex; align-items: center;
      justify-content: center; gap: 20px; flex-shrink: 0;
    }
    .ctrl-btn {
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
      transition: transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    .ctrl-btn:active { transform: scale(0.86); }
    .play-btn {
      width: 72px; height: 72px;
      background: var(--accent); color: #fff; font-size: 1.5rem;
      box-shadow: 0 6px 28px rgba(255,95,31,0.38);
    }
    .play-btn.rest-mode {
      background: var(--rest);
      box-shadow: 0 6px 28px rgba(52,199,89,0.38);
    }
    .sec-btn {
      width: 52px; height: 52px;
      background: var(--surface2); color: var(--text); font-size: 1rem;
    }

    /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
    .progress-section { flex-shrink: 0; }
    .progress-track {
      height: 3px; border-radius: 999px;
      background: var(--surface2); overflow: hidden; margin-bottom: 8px;
    }
    .progress-fill {
      height: 100%; background: var(--accent);
      border-radius: 999px; width: 0%; transition: width 0.4s ease;
    }
    .progress-meta {
      display: flex; justify-content: space-between;
      font-size: 0.7rem; color: var(--text2);
      font-weight: 600; font-variant-numeric: tabular-nums;
    }

    /* ‚îÄ‚îÄ COMPLETION OVERLAY ‚îÄ‚îÄ */
    .completion {
      position: fixed; inset: 0; background: var(--bg);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center; text-align: center;
      padding: 40px 32px calc(var(--tab-h) + env(safe-area-inset-bottom) + 40px);
      z-index: 30; gap: 10px;
    }
    .completion.hidden { display: none; }
    .completion-icon { font-size: 4rem; margin-bottom: 4px; }
    .completion-title {
      font-size: 2.4rem; font-weight: 800; letter-spacing: -0.04em;
    }
    .completion-sub { font-size: 0.95rem; color: var(--text2); margin-bottom: 8px; }

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn-primary {
      width: 100%; padding: 17px; background: var(--accent); color: #fff;
      border-radius: var(--r-md); font-size: 1rem; font-weight: 700;
      letter-spacing: -0.01em;
      transition: transform 0.12s cubic-bezier(0.34,1.56,0.64,1);
    }
    .btn-primary:active { transform: scale(0.97); }
    .btn-secondary {
      width: 100%; padding: 14px; background: var(--surface2); color: var(--text);
      border-radius: var(--r-md); font-size: 0.9rem; font-weight: 600;
      transition: transform 0.12s cubic-bezier(0.34,1.56,0.64,1); margin-top: 10px;
    }
    .btn-secondary:active { transform: scale(0.97); }

    /* ‚îÄ‚îÄ BOTTOM TAB BAR ‚îÄ‚îÄ */
    .tab-bar {
      position: fixed; bottom: 0;
      left: 50%; transform: translateX(-50%);
      width: min(430px, 100%);
      height: calc(var(--tab-h) + env(safe-area-inset-bottom));
      padding-bottom: env(safe-area-inset-bottom);
      background: var(--bg-glass);
      backdrop-filter: blur(24px) saturate(180%);
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      border-top: 1px solid var(--border);
      display: grid; grid-template-columns: repeat(3, 1fr);
      z-index: 40;
    }
    .tab {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 3px;
      font-size: 0.62rem; font-weight: 600;
      color: var(--text2); letter-spacing: 0.01em;
      padding: 8px 4px 0;
      transition: color 0.2s;
    }
    .tab.active { color: var(--accent); }
    .tab-icon { font-size: 1.25rem; line-height: 1; }

    /* ‚îÄ‚îÄ ROUTINE PAGE ‚îÄ‚îÄ */
    .routine-heading {
      font-size: 1rem; font-weight: 700;
      letter-spacing: -0.02em; color: var(--text2);
    }
    .step-list {
      list-style: none; display: flex; flex-direction: column;
      gap: 1px; background: var(--surface2);
      border-radius: var(--r-lg); overflow: hidden;
      border: 1px solid var(--border);
    }
    .step-list li {
      display: flex; align-items: center; gap: 14px;
      padding: 14px 18px; background: var(--surface);
      font-size: 0.9rem; font-weight: 500;
      cursor: pointer; transition: opacity 0.12s;
    }
    .step-list li:active { opacity: 0.55; }
    .step-list li.active-step .step-num { color: var(--accent); }
    .step-num {
      font-size: 0.7rem; font-weight: 700; color: var(--text2);
      min-width: 20px; text-align: right; font-variant-numeric: tabular-nums;
    }
    .step-dur {
      margin-left: auto; font-size: 0.75rem;
      color: var(--text2); font-variant-numeric: tabular-nums;
    }

    /* ‚îÄ‚îÄ SETTINGS PAGE ‚îÄ‚îÄ */
    .settings-group { display: flex; flex-direction: column; gap: 10px; }
    .settings-label {
      font-size: 0.7rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.1em;
      color: var(--text2); padding: 0 4px;
    }
    .settings-cell {
      display: flex; align-items: center; justify-content: space-between;
      background: var(--surface); border-radius: var(--r-md);
      padding: 14px 18px; font-size: 0.9rem; font-weight: 500;
      border: 1px solid var(--border); box-shadow: var(--shadow);
    }
    .settings-cell select {
      background: none; border: none; color: var(--accent);
      font-size: 0.9rem; font-weight: 600; cursor: pointer; text-align: right;
    }

    /* ‚îÄ‚îÄ DURATION EDITOR ‚îÄ‚îÄ */
    .dur-editor {
      background: var(--surface); border-radius: var(--r-md);
      overflow: hidden; border: 1px solid var(--border); box-shadow: var(--shadow);
    }
    .dur-row {
      display: grid; grid-template-columns: 1fr 72px; gap: 12px;
      align-items: center; padding: 12px 18px;
      border-bottom: 1px solid var(--border);
    }
    .dur-row:last-child { border-bottom: none; }
    .dur-label { font-size: 0.84rem; font-weight: 500; }
    .dur-input {
      padding: 8px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--surface2); color: var(--text);
      font-family: var(--ff); font-size: 0.88rem; font-weight: 600;
      text-align: center; font-variant-numeric: tabular-nums; width: 100%;
    }

    /* ‚îÄ‚îÄ STATS & HISTORY ‚îÄ‚îÄ */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .stat-card {
      background: var(--surface); border-radius: var(--r-md);
      padding: 18px 16px; border: 1px solid var(--border); box-shadow: var(--shadow);
    }
    .stat-val {
      font-size: 2.1rem; font-weight: 800; color: var(--accent);
      letter-spacing: -0.04em; line-height: 1; margin-bottom: 4px;
    }
    .stat-lbl {
      font-size: 0.68rem; color: var(--text2); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.06em;
    }
    .history-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
    .history-item {
      display: flex; align-items: center; gap: 14px;
      padding: 14px 18px; background: var(--surface);
      border-radius: var(--r-md); border: 1px solid var(--border); box-shadow: var(--shadow);
    }
    .h-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); flex-shrink: 0; }
    .h-info { flex: 1; }
    .h-name { font-size: 0.88rem; font-weight: 600; margin-bottom: 2px; }
    .h-date { font-size: 0.7rem; color: var(--text2); }
    .h-dur  { font-size: 0.78rem; color: var(--text2); font-variant-numeric: tabular-nums; }
    .empty-state {
      text-align: center; padding: 40px 20px; color: var(--text2); font-size: 0.88rem;
    }
    .empty-icon { font-size: 2.5rem; margin-bottom: 12px; }
    .version-note { font-size: 0.72rem; color: var(--text2); text-align: center; padding: 4px 0; }

    /* ‚îÄ‚îÄ DEBUG PANEL ‚îÄ‚îÄ */
    .debug-panel {
      display: none; font-size: 0.7rem; color: var(--text2);
      border: 1px dashed var(--border); border-radius: 12px;
      padding: 12px 14px; line-height: 2;
    }
    .debug-panel.visible { display: block; }

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(7px); }
      to   { opacity: 1; transform: translateY(0);   }
    }
    .step-info.animating .step-name { animation: fadeUp 0.28s cubic-bezier(0.22,1,0.36,1) both; }
    .step-info.animating .step-meta { animation: fadeUp 0.28s cubic-bezier(0.22,1,0.36,1) 0.04s both; }
  </style>
</head>
<body>
<div class="app">

  <div id="updateBanner" role="status" aria-live="polite">
    <span>Update available</span>
    <button id="reloadBtn">Reload</button>
  </div>

  <!-- ‚ïê‚ïê TIMER PAGE ‚ïê‚ïê -->
  <section id="timerPage" class="page active" role="tabpanel" aria-labelledby="tab-timer">
    <header class="app-header">
      <span class="wordmark" id="wordmark">Stretch</span>
      <div class="header-actions">
        <span id="headerRemaining" class="remaining-pill">‚Äî left</span>
        <button id="soundBtn" class="icon-btn" aria-label="Toggle sound">üîî</button>
      </div>
    </header>

    <div class="mode-toggle" role="radiogroup" id="timerSeg">
      <button class="mode-btn" data-key="short" onclick="switchMode('short')">10 Min</button>
      <button class="mode-btn" data-key="long"  onclick="switchMode('long')">20 Min</button>
    </div>

    <div class="step-info" id="stepInfo">
      <div class="step-name" id="stepName">Ready to stretch</div>
      <div class="step-meta" id="stepMeta">Press play to begin</div>
    </div>

    <div class="ring-wrap">
      <svg viewBox="0 0 100 100" class="ring-svg" aria-hidden="true">
        <circle class="ring-bg" cx="50" cy="50" r="44"/>
        <circle class="ring-fg" id="ringFg" cx="50" cy="50" r="44"/>
      </svg>
      <div class="ring-center" aria-live="polite" aria-atomic="true">
        <span class="ring-time"  id="ringTime">‚Äî:‚Äî‚Äî</span>
        <span class="ring-phase" id="ringPhase">ready</span>
      </div>
    </div>

    <div class="dots" id="stepDots" aria-hidden="true"></div>

    <div class="controls">
      <button class="ctrl-btn sec-btn" aria-label="Previous step" onclick="prevStep()">‚èÆ</button>
      <button class="ctrl-btn play-btn" id="playBtn" aria-label="Play" onclick="togglePlay()">‚ñ∂</button>
      <button class="ctrl-btn sec-btn" aria-label="Skip step"     onclick="nextStep(false)">‚è≠</button>
    </div>

    <div class="progress-section">
      <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-meta">
        <span id="stepProgressText">Step ‚Äî of ‚Äî</span>
        <span id="stepProgressPct">0%</span>
      </div>
    </div>

    <div id="completionCard" class="completion hidden" aria-live="assertive">
      <div class="completion-icon">üéâ</div>
      <div class="completion-title">Session complete</div>
      <div class="completion-sub" id="completionSub">Great work.</div>
      <button class="btn-primary" onclick="startAgain()">Start Again</button>
    </div>
  </section>

  <!-- ‚ïê‚ïê ROUTINE PAGE ‚ïê‚ïê -->
  <section id="routinePage" class="page" role="tabpanel" aria-labelledby="tab-routine">
    <header class="app-header">
      <span class="wordmark">Routine</span>
    </header>
    <div class="mode-toggle" role="radiogroup" id="routineSeg">
      <button class="mode-btn" data-key="short" onclick="switchMode('short')">10 Min</button>
      <button class="mode-btn" data-key="long"  onclick="switchMode('long')">20 Min</button>
    </div>
    <div class="routine-heading" id="routineHeading"></div>
    <ul class="step-list" id="stepList"></ul>
  </section>

  <!-- ‚ïê‚ïê SETTINGS PAGE ‚ïê‚ïê -->
  <section id="settingsPage" class="page" role="tabpanel" aria-labelledby="tab-settings">
    <header class="app-header">
      <span class="wordmark">Settings</span>
    </header>

    <div class="settings-group">
      <div class="settings-label">Appearance</div>
      <div class="settings-cell">
        <span>Theme</span>
        <select id="themeSelect">
          <option value="system">System</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
    </div>

    <div class="settings-group">
      <div class="settings-label">Edit Durations (seconds)</div>
      <div class="mode-toggle" role="radiogroup" id="settingsSeg">
        <button class="mode-btn" data-key="short" onclick="switchMode('short')">10 Min</button>
        <button class="mode-btn" data-key="long"  onclick="switchMode('long')">20 Min</button>
      </div>
      <div class="dur-editor" id="durEditor"></div>
      <button class="btn-secondary" onclick="resetDurations()">Reset to Defaults</button>
    </div>

    <div class="settings-group">
      <div class="settings-label">History</div>
      <div class="stats-grid" id="statsGrid"></div>
      <div class="history-list" id="historyList"></div>
    </div>

    <div class="version-note">Version <span id="versionLabel">‚Äî</span></div>
    <div class="debug-panel" id="debugPanel"></div>
  </section>

  <!-- ‚ïê‚ïê BOTTOM TAB BAR ‚ïê‚ïê -->
  <nav class="tab-bar" role="tablist">
    <button id="tab-timer"    class="tab active" role="tab" aria-selected="true"  onclick="showTab('timer')">
      <span class="tab-icon">‚óé</span><span>Timer</span>
    </button>
    <button id="tab-routine"  class="tab"        role="tab" aria-selected="false" onclick="showTab('routine')">
      <span class="tab-icon">‚â°</span><span>Routine</span>
    </button>
    <button id="tab-settings" class="tab"        role="tab" aria-selected="false" onclick="showTab('settings')">
      <span class="tab-icon">‚óØ</span><span>Settings</span>
    </button>
  </nav>

</div>
<script>
// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ
const APP_VERSION = 'v3.0-2026.02.21';
const STORAGE_KEY = 'stretch-timer-v3';
const HISTORY_KEY = 'stretch-timer-history';
const RING_CIRC   = 276.46; // 2œÄ √ó 44
const REST_SECS   = 12;

// ‚îÄ‚îÄ ROUTINES ‚îÄ‚îÄ
const BASE = {
  short: [
    { label: 'Left Hip Flexor (Half-Kneeling)',  seconds: 60 },
    { label: 'Right Hip Flexor (Half-Kneeling)', seconds: 60 },
    { label: 'Left Couch Stretch',               seconds: 60 },
    { label: 'Right Couch Stretch',              seconds: 60 },
    { label: 'Left Hamstring',                   seconds: 60 },
    { label: 'Right Hamstring',                  seconds: 60 },
    { label: 'Left Quad Stretch',                seconds: 60 },
    { label: 'Right Quad Stretch',               seconds: 60 },
    { label: 'Thoracic Opener',                  seconds: 60 },
    { label: "Child's Pose",                     seconds: 60 },
  ],
  long: [
    { label: 'Left Hip Flexor (Half-Kneeling)',  seconds: 75 },
    { label: 'Right Hip Flexor (Half-Kneeling)', seconds: 75 },
    { label: 'Left Couch Stretch',               seconds: 75 },
    { label: 'Right Couch Stretch',              seconds: 75 },
    { label: 'Left Pigeon Pose',                 seconds: 75 },
    { label: 'Right Pigeon Pose',                seconds: 75 },
    { label: 'Left Hamstring (Supine)',          seconds: 75 },
    { label: 'Right Hamstring (Supine)',         seconds: 75 },
    { label: 'Left Quad Stretch',                seconds: 60 },
    { label: 'Right Quad Stretch',               seconds: 60 },
    { label: 'Adductor Rock-Back',               seconds: 60 },
    { label: 'Calf Stretch (Wall)',              seconds: 60 },
    { label: 'Thoracic Opener (Open Book)',      seconds: 60 },
    { label: "Child's Pose",                     seconds: 60 },
    { label: 'Supine Spinal Twist (Left)',       seconds: 60 },
    { label: 'Supine Spinal Twist (Right)',      seconds: 60 },
  ],
};

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
const S = {
  key:          'long',
  routines:     null,   // populated by applyDurs()
  durations:    { short: [], long: [] },
  idx:          0,
  remaining:    0,
  total:        0,
  running:      false,
  resting:      false,
  rafId:        null,
  endsAt:       0,
  done:         false,
  theme:        'system',
  sound:        true,
  sessionStart: null,
  wakeLock:     null,
  dbg:          false,
};

// ‚îÄ‚îÄ AUDIO ‚îÄ‚îÄ
let audioCtx = null;
const getCtx = () => audioCtx || (audioCtx = new (window.AudioContext || window.webkitAudioContext)());

function tone(freq, dur, vol = 0.22, type = 'sine') {
  if (!S.sound) return;
  try {
    const ctx = getCtx(), o = ctx.createOscillator(), g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = type; o.frequency.value = freq;
    g.gain.setValueAtTime(vol, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
    o.start(); o.stop(ctx.currentTime + dur);
  } catch (e) {}
}
const chimeStart = () => { tone(523,.25); setTimeout(()=>tone(659,.25),100); setTimeout(()=>tone(784,.4),200); };
const chimeRest  = () => tone(440,.4,'triangle',.18);
const chimeDone  = () => { tone(523,.2); setTimeout(()=>tone(659,.2),90); setTimeout(()=>tone(784,.2),180); setTimeout(()=>tone(1047,.55),270); };
const chimeBeep  = () => tone(880,.12,'square',.08);

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
const cur      = () => S.routines[S.key];
const step     = () => cur()[S.idx];
const $        = id => document.getElementById(id);
const fmt      = s  => { s = Math.max(0, Math.floor(s)); return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; };
const remTotal = () => cur().slice(S.idx + 1).reduce((a, s) => a + s.seconds, 0) + S.remaining;

// ‚îÄ‚îÄ PERSISTENCE ‚îÄ‚îÄ
function applyDurs(ov) {
  if (!S.routines) S.routines = {};
  ['short','long'].forEach(k => {
    const b = BASE[k], src = Array.isArray(ov?.[k]) ? ov[k] : [];
    S.durations[k] = b.map((s, i) => {
      const v = Number(src[i]);
      return Number.isFinite(v) ? Math.min(600, Math.max(15, Math.round(v))) : s.seconds;
    });
    S.routines[k] = b.map((s, i) => ({ ...s, seconds: S.durations[k][i] }));
  });
}

function loadSettings() {
  applyDurs(null);
  try {
    const p = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    if (['system','light','dark'].includes(p.theme)) S.theme = p.theme;
    if (['short','long'].includes(p.key))            S.key   = p.key;
    if (typeof p.sound === 'boolean')                S.sound = p.sound;
    applyDurs(p.durations);
  } catch (e) {}
}

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    theme: S.theme, key: S.key, sound: S.sound, durations: S.durations,
  }));
}

function saveHistory(name, mins, stretches) {
  try {
    const h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    h.unshift({ routine: name, date: new Date().toISOString(), mins, stretches });
    localStorage.setItem(HISTORY_KEY, JSON.stringify(h.slice(0, 60)));
  } catch (e) {}
}

// ‚îÄ‚îÄ WAKE LOCK ‚îÄ‚îÄ
async function acquireWakeLock() {
  if (!('wakeLock' in navigator) || S.wakeLock) return;
  try { S.wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
}
function releaseWakeLock() {
  if (S.wakeLock) { S.wakeLock.release().catch(() => {}); S.wakeLock = null; }
}

// ‚îÄ‚îÄ PAGE VISIBILITY ‚Äî keep clock running in background ‚îÄ‚îÄ
document.addEventListener('visibilitychange', () => {
  if (!S.running) return;
  if (document.hidden) {
    if (S.rafId) { cancelAnimationFrame(S.rafId); S.rafId = null; }
    releaseWakeLock();
  } else {
    const left = Math.max(0, Math.ceil((S.endsAt - Date.now()) / 1000));
    if (left <= 0) { S.remaining = 0; render(); onEnd(); return; }
    S.remaining = left;
    render();
    S.rafId = requestAnimationFrame(tick);
    acquireWakeLock();
  }
});

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ
function applyTheme() {
  const r = document.documentElement;
  if (S.theme === 'system') r.removeAttribute('data-theme');
  else r.setAttribute('data-theme', S.theme);
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function showTab(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
  $(`${name}Page`).classList.add('active');
  const ids = { timer: 'tab-timer', routine: 'tab-routine', settings: 'tab-settings' };
  const t = $(ids[name]);
  if (t) { t.classList.add('active'); t.setAttribute('aria-selected','true'); }
  if (name === 'routine')  buildStepList();
  if (name === 'settings') { buildDurEditor(); renderHistory(); }
}

// ‚îÄ‚îÄ SYNC ALL SEGMENTED CONTROLS ‚îÄ‚îÄ
function syncAll() {
  ['timerSeg','routineSeg','settingsSeg'].forEach(id => {
    const w = $(id); if (!w) return;
    w.querySelectorAll('[data-key]').forEach(b => b.classList.toggle('active', b.dataset.key === S.key));
  });
  const ts = $('themeSelect'); if (ts) ts.value = S.theme;
  $('soundBtn').textContent  = S.sound ? 'üîî' : 'üîï';
  $('versionLabel').textContent = APP_VERSION;
}

// ‚îÄ‚îÄ STEP NAME ANIMATION ‚îÄ‚îÄ
function animateStepInfo() {
  const el = $('stepInfo');
  el.classList.remove('animating');
  void el.offsetWidth; // force reflow to restart animation
  el.classList.add('animating');
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function render() {
  if (S.done) {
    $('completionCard').classList.remove('hidden');
    syncAll(); applyTheme(); return;
  }
  $('completionCard').classList.add('hidden');

  const r   = cur();
  const s   = step();
  const pct = Math.round((S.idx / r.length) * 100);
  const off = RING_CIRC * (1 - Math.min(1, Math.max(0, S.remaining / S.total)));

  // Ring
  $('ringFg').style.strokeDashoffset = off;
  $('ringFg').classList.toggle('rest-color', S.resting);
  $('ringTime').textContent  = fmt(S.remaining);
  $('ringPhase').textContent = S.resting ? 'rest' : 'stretch';

  // Step info
  $('stepName').textContent = S.resting ? 'Rest' : s.label;
  $('stepMeta').textContent = S.resting
    ? `Next: ${r[S.idx + 1]?.label || 'last one!'}`
    : `Step ${S.idx + 1} of ${r.length}`;

  // Play button
  const pb = $('playBtn');
  pb.textContent = S.running ? '‚è∏' : '‚ñ∂';
  pb.setAttribute('aria-label', S.running ? 'Pause' : 'Play');
  pb.classList.toggle('rest-mode', S.resting);

  // Progress
  $('progressFill').style.width     = `${pct}%`;
  $('stepProgressText').textContent = `Step ${S.idx + 1} of ${r.length}`;
  $('stepProgressPct').textContent  = `${pct}%`;
  $('headerRemaining').textContent  = `${fmt(remTotal())} left`;

  buildDots();
  syncAll();
  applyTheme();
  if (S.dbg) renderDebug();
}

function buildDots() {
  const r = cur(), c = $('stepDots');
  c.innerHTML = '';
  r.forEach((_, i) => {
    const d = document.createElement('div');
    d.className = 'dot' +
      (i < S.idx              ? ' done'       :
       i === S.idx && S.resting ? ' rest-active' :
       i === S.idx             ? ' active'    : '');
    d.title = r[i].label;
    d.addEventListener('click', () => jumpTo(i));
    c.appendChild(d);
  });
}

function buildStepList() {
  const r = cur(), sl = $('stepList');
  sl.innerHTML = '';
  $('routineHeading').textContent = S.key === 'long' ? '20 Min Routine' : '10 Min Routine';
  r.forEach((s, i) => {
    const li = document.createElement('li');
    li.className = i === S.idx ? 'active-step' : '';
    li.innerHTML = `<span class="step-num">${i + 1}</span><span>${s.label}</span><span class="step-dur">${fmt(s.seconds)}</span>`;
    li.addEventListener('click', () => jumpTo(i));
    sl.appendChild(li);
  });
}

function buildDurEditor() {
  const r = cur(), de = $('durEditor');
  de.innerHTML = '';
  r.forEach((s, i) => {
    const row = document.createElement('div'); row.className = 'dur-row';
    const lbl = document.createElement('label'); lbl.className = 'dur-label'; lbl.textContent = s.label; lbl.htmlFor = `d${i}`;
    const inp = document.createElement('input');
    inp.type = 'number'; inp.min = 15; inp.max = 600; inp.step = 5;
    inp.id = `d${i}`; inp.className = 'dur-input'; inp.value = s.seconds;
    inp.addEventListener('change', () => {
      const v = Math.min(600, Math.max(15, Math.round(Number(inp.value) || s.seconds)));
      inp.value = v;
      S.durations[S.key][i] = v; S.routines[S.key][i].seconds = v;
      if (S.idx === i && !S.resting) { S.remaining = Math.min(S.remaining, v); S.total = v; }
      save(); render();
    });
    row.append(lbl, inp); de.appendChild(row);
  });
}

function renderHistory() {
  try {
    const h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    const sessions  = h.length;
    const mins      = h.reduce((a, b) => a + b.mins, 0);
    const stretches = h.reduce((a, b) => a + b.stretches, 0);
    const streak    = calcStreak(h);
    $('statsGrid').innerHTML = `
      <div class="stat-card"><div class="stat-val">${sessions}</div><div class="stat-lbl">Sessions</div></div>
      <div class="stat-card"><div class="stat-val">${streak}üî•</div><div class="stat-lbl">Day streak</div></div>
      <div class="stat-card"><div class="stat-val">${mins}</div><div class="stat-lbl">Total mins</div></div>
      <div class="stat-card"><div class="stat-val">${stretches}</div><div class="stat-lbl">Stretches</div></div>
    `;
    const hl = $('historyList');
    hl.innerHTML = '';
    if (!h.length) {
      hl.innerHTML = '<div class="empty-state"><div class="empty-icon">üßò</div>Complete a session to see your history</div>';
      return;
    }
    h.slice(0, 10).forEach(s => {
      const d = document.createElement('div'); d.className = 'history-item';
      d.innerHTML = `<div class="h-dot"></div><div class="h-info"><div class="h-name">${s.routine}</div><div class="h-date">${fmtDate(s.date)}</div></div><div class="h-dur">${s.mins} min</div>`;
      hl.appendChild(d);
    });
  } catch (e) {}
}

function calcStreak(h) {
  if (!h.length) return 0;
  const days = [...new Set(h.map(s => s.date.slice(0, 10)))].sort().reverse();
  let streak = 0, check = new Date(); check.setHours(0, 0, 0, 0);
  for (const d of days) {
    const dd = new Date(d), diff = Math.round((check - dd) / 86400000);
    if (diff <= 1) { streak++; check = dd; } else break;
  }
  return streak;
}

function fmtDate(iso) {
  return new Date(iso).toLocaleDateString('en-US', {
    weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit',
  });
}

function renderDebug() {
  $('debugPanel').innerHTML =
    `mode:${S.key} | theme:${S.theme} | sound:${S.sound} | wake:${!!S.wakeLock}<br>` +
    `step:${S.idx} | rem:${S.remaining}s | rest:${S.resting} | ver:${APP_VERSION}`;
}

// ‚îÄ‚îÄ RAF TICKER ‚îÄ‚îÄ smooth 60fps ring, discrete second updates
function tick() {
  if (!S.running) return;
  const msLeft = Math.max(0, S.endsAt - Date.now());
  const secsLeft = Math.ceil(msLeft / 1000);

  // Smooth ring every frame
  const frac = Math.min(1, msLeft / 1000 / S.total);
  $('ringFg').style.strokeDashoffset = (RING_CIRC * (1 - frac)).toFixed(3);

  // Discrete updates when the second changes
  if (secsLeft !== S.remaining) {
    S.remaining = secsLeft;
    $('ringTime').textContent       = fmt(secsLeft);
    $('headerRemaining').textContent = `${fmt(remTotal())} left`;
    if (secsLeft <= 3 && secsLeft > 0) chimeBeep();
    if (secsLeft <= 0) { onEnd(); return; }
  }
  S.rafId = requestAnimationFrame(tick);
}

function startTicker() {
  stopTicker();
  S.running = true;
  S.endsAt  = Date.now() + S.remaining * 1000;
  S.rafId   = requestAnimationFrame(tick);
  acquireWakeLock();
}

function stopTicker() {
  if (S.rafId) { cancelAnimationFrame(S.rafId); S.rafId = null; }
  S.running = false;
  releaseWakeLock();
}

// ‚îÄ‚îÄ TIMER LOGIC ‚îÄ‚îÄ
function onEnd() {
  if (S.resting) {
    chimeStart(); loadStep(S.idx + 1); startTicker();
  } else if (S.idx < cur().length - 1) {
    chimeRest(); loadRest(); startTicker();
  } else {
    chimeDone(); finish();
  }
}

function loadStep(i) {
  S.idx = i; S.resting = false; S.done = false;
  const s = step(); S.remaining = s.seconds; S.total = s.seconds;
  animateStepInfo(); render();
}

function loadRest() {
  S.resting = true; S.remaining = REST_SECS; S.total = REST_SECS;
  render();
}

function finish() {
  stopTicker(); S.done = true;
  const mins = Math.max(1, Math.round((Date.now() - (S.sessionStart || Date.now())) / 60000));
  $('completionSub').textContent = `You completed ${cur().length} stretches in ~${mins} minute${mins !== 1 ? 's' : ''}.`;
  saveHistory(S.key === 'long' ? '20 Min Routine' : '10 Min Routine', mins, cur().length);
  render();
}

function togglePlay() {
  if (S.done) return;
  if (S.running) { stopTicker(); render(); }
  else {
    if (!S.sessionStart) S.sessionStart = Date.now();
    getCtx(); // unlock audio on first user gesture
    if (S.remaining === S.total && !S.resting) chimeStart();
    startTicker();
  }
}

function nextStep(auto = true) {
  if (S.done) return;
  const was = S.running; stopTicker();
  if (!S.resting && S.idx < cur().length - 1)     { loadRest(); }
  else if (S.resting && S.idx < cur().length - 1) { loadStep(S.idx + 1); }
  else { finish(); return; }
  if (was || auto) startTicker();
}

function prevStep() {
  const was = S.running; stopTicker();
  if (S.resting)        { loadStep(S.idx); }
  else if (S.idx > 0)   { loadStep(S.idx - 1); }
  else                  { render(); }
  if (was) startTicker();
}

function jumpTo(i) {
  stopTicker(); loadStep(i); showTab('timer');
}

function startAgain() {
  stopTicker(); S.idx = 0; S.resting = false; S.done = false; S.sessionStart = null;
  const s = step(); S.remaining = s.seconds; S.total = s.seconds;
  animateStepInfo(); render();
}

function switchMode(key) {
  if (!['short','long'].includes(key) || key === S.key) return;
  stopTicker(); S.key = key; S.idx = 0; S.resting = false; S.done = false; S.sessionStart = null;
  const s = step(); S.remaining = s.seconds; S.total = s.seconds;
  save(); render(); buildDurEditor(); buildStepList();
}

function resetDurations() {
  applyDurs(null); S.idx = 0; S.resting = false; S.done = false;
  const s = step(); S.remaining = s.seconds; S.total = s.seconds;
  save(); render(); buildDurEditor();
}

// ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ
$('soundBtn').addEventListener('click', () => { S.sound = !S.sound; save(); render(); });
$('themeSelect').addEventListener('change', () => { S.theme = $('themeSelect').value; save(); applyTheme(); syncAll(); });

// Long-press wordmark to toggle debug panel
let _lp = null;
$('wordmark').addEventListener('pointerdown', () => {
  _lp = setTimeout(() => {
    S.dbg = !S.dbg;
    $('debugPanel').classList.toggle('visible', S.dbg);
    if (S.dbg) renderDebug();
  }, 800);
});
['pointerup','pointercancel','pointerleave'].forEach(ev => $('wordmark').addEventListener(ev, () => clearTimeout(_lp)));

// ‚îÄ‚îÄ SERVICE WORKER ‚îÄ‚îÄ
function setupSW() {
  if (!('serviceWorker' in navigator)) return;
  if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') return;
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('./sw.js');
      const showBanner = r => {
        if (!r?.waiting) return;
        $('updateBanner').classList.add('visible');
        $('reloadBtn').onclick = () => r.waiting.postMessage({ type: 'SKIP_WAITING' });
      };
      if (reg.waiting) showBanner(reg);
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        nw?.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) showBanner(reg);
        });
      });
      navigator.serviceWorker.addEventListener('controllerchange', () => location.reload());
    } catch (e) {}
  });
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
loadSettings();
setupSW();
const _s = step(); S.remaining = _s.seconds; S.total = _s.seconds;
applyTheme();
render();
</script>
</body>
</html>
