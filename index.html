<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Stretch Timer" />
  <title>Stretch Timer v3</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f3f4f6;
      --surface: #ffffff;
      --surface-secondary: #eceff3;
      --text: #111827;
      --text-muted: #6b7280;
      --border: rgba(17, 24, 39, 0.12);
      --accent: #0ea5e9;
      --accent-strong: #0284c7;
      --ok: #10b981;
      --danger: #ef4444;
      --ring-track: rgba(14, 165, 233, 0.2);
      --shadow-soft: 0 8px 24px rgba(15, 23, 42, 0.08);
      --radius-card: 20px;
      --radius-control: 14px;
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 24px;
      --title: clamp(1.1rem, 2.8vw, 1.3rem);
      --subtitle: clamp(1rem, 2.3vw, 1.05rem);
      --body: 0.95rem;
      --caption: 0.82rem;
    }

    :root[data-theme="dark"] {
      --bg: #030712;
      --surface: #111827;
      --surface-secondary: #1f2937;
      --text: #f9fafb;
      --text-muted: #9ca3af;
      --border: rgba(156, 163, 175, 0.28);
      --accent: #38bdf8;
      --accent-strong: #0ea5e9;
      --ok: #34d399;
      --danger: #f87171;
      --ring-track: rgba(56, 189, 248, 0.22);
      --shadow-soft: 0 10px 30px rgba(2, 6, 23, 0.45);
    }

    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) {
        --bg: #030712;
        --surface: #111827;
        --surface-secondary: #1f2937;
        --text: #f9fafb;
        --text-muted: #9ca3af;
        --border: rgba(156, 163, 175, 0.28);
        --accent: #38bdf8;
        --accent-strong: #0ea5e9;
        --ok: #34d399;
        --danger: #f87171;
        --ring-track: rgba(56, 189, 248, 0.22);
        --shadow-soft: 0 10px 30px rgba(2, 6, 23, 0.45);
      }
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      min-height: 100dvh;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: var(--body);
    }

    .app {
      max-width: 980px;
      margin: 0 auto;
      padding: calc(var(--space-3) + env(safe-area-inset-top)) var(--space-3) calc(var(--space-5) + env(safe-area-inset-bottom));
      display: grid;
      gap: var(--space-3);
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-soft);
      padding: var(--space-4);
    }

    .bento-grid {
      display: grid;
      gap: var(--space-3);
      align-items: start;
      grid-template-columns: 1fr;
    }

    @media (min-width: 860px) {
      .bento-grid {
        grid-template-columns: 1.3fr 1fr;
        grid-template-areas:
          "hero step"
          "controls summary"
          "panels panels";
      }
      .hero { grid-area: hero; }
      .step-card { grid-area: step; }
      .controls-card { grid-area: controls; }
      .summary-card { grid-area: summary; }
      .panel-card { grid-area: panels; }
    }

    .row { display: flex; align-items: center; justify-content: space-between; gap: var(--space-3); }
    .stack { display: grid; gap: var(--space-2); }

    .app-title { margin: 0; font-size: var(--title); letter-spacing: -0.01em; }
    .status { margin: 0; color: var(--text-muted); font-size: var(--caption); }
    .caption { color: var(--text-muted); font-size: var(--caption); }

    .pill {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 650;
      background: var(--surface-secondary);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    .timer-wrap {
      display: grid;
      place-items: center;
      gap: var(--space-2);
      padding: var(--space-2) 0;
    }

    .timer {
      font-size: clamp(3.4rem, 16vw, 5.4rem);
      line-height: 1;
      font-weight: 800;
      letter-spacing: 0.03em;
      font-variant-numeric: tabular-nums;
    }

    .progress-wrap { display: grid; gap: var(--space-2); }

    .progress-label {
      display: flex;
      justify-content: space-between;
      gap: var(--space-2);
      font-size: var(--caption);
      color: var(--text-muted);
      font-weight: 620;
    }

    .progress-bar {
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: var(--ring-track);
    }

    .progress-bar > span {
      display: block;
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, var(--ok), var(--accent));
      transition: width 0.24s ease;
    }

    .current-step { margin: 0; font-size: var(--subtitle); font-weight: 660; }
    .step-cue { margin: 0; color: var(--text-muted); font-size: var(--caption); }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: var(--space-2);
    }

    button,
    input[type="number"] {
      border: 1px solid var(--border);
      border-radius: var(--radius-control);
      background: var(--surface-secondary);
      color: var(--text);
      font: inherit;
    }

    button {
      min-height: 52px;
      padding: 12px;
      font-weight: 650;
      cursor: pointer;
      transition: transform 0.08s ease, filter 0.12s ease;
      -webkit-tap-highlight-color: transparent;
    }

    button:active { transform: scale(0.98); }
    button:hover { filter: brightness(0.98); }

    .primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: color-mix(in srgb, var(--accent) 72%, black);
      color: #02253c;
      font-weight: 760;
    }

    .danger {
      color: var(--danger);
      border-color: color-mix(in srgb, var(--danger) 45%, transparent);
    }

    .button-icon {
      min-height: 44px;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: var(--caption);
      font-weight: 700;
    }

    .panel-header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: var(--space-2); }

    .collapsible {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transform: translateY(-2px);
      transition: max-height 0.28s ease, opacity 0.2s ease, transform 0.2s ease;
    }

    .collapsible.open {
      max-height: 1200px;
      opacity: 1;
      transform: translateY(0);
      margin-top: var(--space-3);
    }

    .settings-grid {
      display: grid;
      gap: var(--space-2);
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
    }

    label.setting {
      display: flex;
      gap: 10px;
      align-items: center;
      color: var(--text-muted);
      font-weight: 600;
      padding: 8px 0;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--accent);
    }

    .list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: var(--space-2);
    }

    .list-item {
      border: 1px solid var(--border);
      border-radius: var(--radius-control);
      padding: var(--space-3);
      display: grid;
      gap: var(--space-2);
      background: var(--surface-secondary);
    }

    .list-item.active {
      border-color: color-mix(in srgb, var(--accent) 58%, var(--border));
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--accent) 44%, transparent);
    }

    .step-name { font-weight: 650; }

    .item-actions {
      display: grid;
      grid-template-columns: 74px repeat(3, auto);
      gap: 6px;
      align-items: center;
      justify-content: start;
    }

    .item-actions input { min-height: 38px; text-align: center; padding: 6px; }
    .item-actions button { min-height: 38px; padding: 6px 10px; font-size: 0.82rem; }

    .completion {
      display: none;
      margin-top: var(--space-2);
      text-align: center;
      border: 1px solid color-mix(in srgb, var(--ok) 38%, var(--border));
      border-radius: var(--radius-control);
      padding: var(--space-3);
      background: color-mix(in srgb, var(--ok) 10%, var(--surface));
    }

    .completion.visible { display: block; }

    :focus-visible {
      outline: 2px solid color-mix(in srgb, var(--accent) 75%, white);
      outline-offset: 2px;
    }

    @media (max-width: 760px) {
      .app { gap: var(--space-2); padding-left: var(--space-2); padding-right: var(--space-2); }
      .card { padding: var(--space-3); }
      .hero { min-height: min(72dvh, 560px); }
      .controls-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .item-actions { grid-template-columns: 70px repeat(3, auto); }
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="bento-grid">
      <article class="card hero stack" aria-label="Main timer">
        <div class="row">
          <div>
            <h1 class="app-title">Stretch Timer</h1>
            <p class="status" id="status">Ready to start</p>
          </div>
          <div class="pill" id="headerRemaining">--:-- left</div>
        </div>

        <div class="timer-wrap">
          <div id="timer" class="timer" aria-live="polite">00:00</div>
          <p id="currentStep" class="current-step">Press Start to begin.</p>
          <p class="step-cue" id="headerStep">Current stretch</p>
        </div>

        <div class="progress-wrap">
          <div class="progress-label">
            <span id="stepProgressText">Step 1 of 1</span>
            <span id="stepProgressPercent">0%</span>
          </div>
          <div class="progress-bar" aria-label="Progress through current routine">
            <span id="progressFill"></span>
          </div>
        </div>

        <button id="startPauseBtn" type="button" class="primary" aria-label="Start or pause timer">‚ñ∂ Start</button>
      </article>

      <article class="card step-card stack">
        <div class="caption">Current stretch</div>
        <p id="stepTitle" class="current-step">Press Start to begin.</p>
        <p id="modeCaption" class="caption">Mode: Full routine</p>
      </article>

      <article class="card controls-card stack">
        <div class="caption">Controls</div>
        <div class="controls-grid">
          <button id="backBtn" type="button" aria-label="Previous stretch">‚èÆ Back</button>
          <button id="nextBtn" type="button" aria-label="Next stretch">Next ‚è≠</button>
          <button id="restartStepBtn" type="button" aria-label="Restart current stretch">‚Ü∫ Restart</button>
          <button id="resetBtn" type="button" class="danger" aria-label="Reset routine">Reset</button>
        </div>
      </article>

      <article class="card summary-card stack">
        <div class="caption">Routine summary</div>
        <div class="pill" id="totals">Total remaining: --:--</div>
        <div class="pill" id="routineDuration">Routine duration: --:--</div>
      </article>

      <article class="card panel-card stack">
        <div class="panel-header">
          <div class="caption">More</div>
          <div class="row">
            <button id="routineToggle" class="button-icon" type="button" aria-expanded="false" aria-controls="routinePanel">Routine</button>
            <button id="settingsToggle" class="button-icon" type="button" aria-expanded="false" aria-controls="settingsPanel">Settings</button>
          </div>
        </div>

        <section id="routinePanel" class="collapsible" aria-hidden="true">
          <p class="caption" style="margin:0 0 8px;">Reorder steps, adjust durations, and jump to any step.</p>
          <ul id="stepList" class="list"></ul>
        </section>

        <section id="settingsPanel" class="collapsible" aria-hidden="true">
          <div class="settings-grid">
            <label class="setting" for="quickModeToggle">
              <input id="quickModeToggle" type="checkbox" /> Quick Stretch Mode
            </label>
            <label class="setting" for="autoAdvanceToggle">
              <input id="autoAdvanceToggle" type="checkbox" checked /> Auto-advance steps
            </label>
            <label class="setting" for="vibrateToggle">
              <input id="vibrateToggle" type="checkbox" checked /> Haptics on step complete
            </label>
            <label class="setting" for="soundToggle">
              <input id="soundToggle" type="checkbox" /> Sound on step change
            </label>
            <label class="setting" for="themeToggle">
              <input id="themeToggle" type="checkbox" /> Force dark theme
            </label>
          </div>
        </section>

        <div id="completionCard" class="completion" aria-live="polite">
          <h2>Routine complete üéâ</h2>
          <p id="completionSummary"></p>
          <button id="startAgainBtn" type="button" class="primary">Start again</button>
        </div>
      </article>
    </section>
  </main>

  <script>
    const STORAGE_KEY = 'stretch-timer-settings-v3';

    const DEFAULT_ROUTINES = {
      full: [
        { label: 'Half-Kneeling Hip Flexor ‚Äî Left', seconds: 60 },
        { label: 'Half-Kneeling Hip Flexor ‚Äî Right', seconds: 60 },
        { label: 'Couch Stretch ‚Äî Left', seconds: 60 },
        { label: 'Couch Stretch ‚Äî Right', seconds: 60 },
        { label: 'Hamstring Stretch ‚Äî Left', seconds: 45 },
        { label: 'Hamstring Stretch ‚Äî Right', seconds: 45 },
        { label: 'Figure-4 Glute Stretch ‚Äî Left', seconds: 45 },
        { label: 'Figure-4 Glute Stretch ‚Äî Right', seconds: 45 },
        { label: 'Thoracic Open Book ‚Äî Left', seconds: 40 },
        { label: 'Thoracic Open Book ‚Äî Right', seconds: 40 }
      ],
      quick: [
        { label: 'Hip Flexor Stretch ‚Äî Left', seconds: 45 },
        { label: 'Hip Flexor Stretch ‚Äî Right', seconds: 45 },
        { label: 'Hamstring Stretch ‚Äî Left', seconds: 35 },
        { label: 'Hamstring Stretch ‚Äî Right', seconds: 35 },
        { label: 'Thoracic Open Book ‚Äî Left', seconds: 30 },
        { label: 'Thoracic Open Book ‚Äî Right', seconds: 30 }
      ]
    };

    const els = {
      timer: document.getElementById('timer'),
      currentStep: document.getElementById('currentStep'),
      stepTitle: document.getElementById('stepTitle'),
      totals: document.getElementById('totals'),
      routineDuration: document.getElementById('routineDuration'),
      status: document.getElementById('status'),
      progressFill: document.getElementById('progressFill'),
      stepProgressText: document.getElementById('stepProgressText'),
      stepProgressPercent: document.getElementById('stepProgressPercent'),
      headerStep: document.getElementById('headerStep'),
      headerRemaining: document.getElementById('headerRemaining'),
      modeCaption: document.getElementById('modeCaption'),
      stepList: document.getElementById('stepList'),
      completionCard: document.getElementById('completionCard'),
      completionSummary: document.getElementById('completionSummary'),
      routineToggle: document.getElementById('routineToggle'),
      settingsToggle: document.getElementById('settingsToggle'),
      routinePanel: document.getElementById('routinePanel'),
      settingsPanel: document.getElementById('settingsPanel'),
      quickModeToggle: document.getElementById('quickModeToggle'),
      startPauseBtn: document.getElementById('startPauseBtn'),
      nextBtn: document.getElementById('nextBtn'),
      backBtn: document.getElementById('backBtn'),
      resetBtn: document.getElementById('resetBtn'),
      restartStepBtn: document.getElementById('restartStepBtn'),
      startAgainBtn: document.getElementById('startAgainBtn'),
      autoAdvanceToggle: document.getElementById('autoAdvanceToggle'),
      vibrateToggle: document.getElementById('vibrateToggle'),
      soundToggle: document.getElementById('soundToggle'),
      themeToggle: document.getElementById('themeToggle')
    };

    const state = {
      mode: 'full',
      routines: structuredClone(DEFAULT_ROUTINES),
      stepIndex: 0,
      remaining: 0,
      isRunning: false,
      autoAdvance: true,
      vibrate: true,
      soundOn: false,
      forceDarkTheme: false,
      ticker: null,
      endsAt: 0,
      completed: false,
      completionSeconds: 0,
      audioCtx: null
    };

    function formatClock(totalSeconds) {
      const s = Math.max(0, Math.floor(totalSeconds));
      const min = Math.floor(s / 60).toString().padStart(2, '0');
      const sec = (s % 60).toString().padStart(2, '0');
      return `${min}:${sec}`;
    }

    function currentRoutine() {
      return state.routines[state.mode];
    }

    function currentStep() {
      return currentRoutine()[state.stepIndex];
    }

    function routineTotalSeconds() {
      return currentRoutine().reduce((sum, step) => sum + step.seconds, 0);
    }

    function remainingTotalSeconds() {
      const routine = currentRoutine();
      return routine.slice(state.stepIndex + 1).reduce((sum, step) => sum + step.seconds, 0) + state.remaining;
    }

    function saveSettings() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        mode: state.mode,
        autoAdvance: state.autoAdvance,
        vibrate: state.vibrate,
        soundOn: state.soundOn,
        forceDarkTheme: state.forceDarkTheme,
        routines: state.routines
      }));
    }

    function normalizeRoutine(routine, fallback) {
      if (!Array.isArray(routine) || !routine.length) return fallback;
      return routine
        .map((step, idx) => ({
          label: typeof step.label === 'string' && step.label.trim() ? step.label.trim() : fallback[idx]?.label || `Stretch ${idx + 1}`,
          seconds: Number.isFinite(step.seconds) ? Math.max(5, Math.min(600, Math.round(step.seconds))) : fallback[idx]?.seconds || 30
        }));
    }

    function loadSettings() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed.mode === 'full' || parsed.mode === 'quick') state.mode = parsed.mode;
        if (typeof parsed.autoAdvance === 'boolean') state.autoAdvance = parsed.autoAdvance;
        if (typeof parsed.vibrate === 'boolean') state.vibrate = parsed.vibrate;
        if (typeof parsed.soundOn === 'boolean') state.soundOn = parsed.soundOn;
        if (typeof parsed.forceDarkTheme === 'boolean') state.forceDarkTheme = parsed.forceDarkTheme;
        if (parsed.routines && typeof parsed.routines === 'object') {
          state.routines.full = normalizeRoutine(parsed.routines.full, DEFAULT_ROUTINES.full);
          state.routines.quick = normalizeRoutine(parsed.routines.quick, DEFAULT_ROUTINES.quick);
        }
      } catch (_) {
        // Ignore invalid settings and continue with defaults.
      }
    }

    function stopTicker() {
      if (state.ticker) {
        clearInterval(state.ticker);
        state.ticker = null;
      }
      state.isRunning = false;
    }

    function playStepTone() {
      if (!state.soundOn) return;
      try {
        if (!state.audioCtx) {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          state.audioCtx = new Ctx();
        }

        if (state.audioCtx.state === 'suspended') {
          state.audioCtx.resume();
        }

        const ctx = state.audioCtx;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = 880;
        gain.gain.value = 0.0001;

        osc.connect(gain);
        gain.connect(ctx.destination);

        const now = ctx.currentTime;
        gain.gain.exponentialRampToValueAtTime(0.08, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);
        osc.start(now);
        osc.stop(now + 0.12);
      } catch (_) {
        // Keep app silent if WebAudio fails.
      }
    }

    function buzz(pattern = 120) {
      if (!state.vibrate || !navigator.vibrate) return;
      navigator.vibrate(pattern);
    }

    function applyTheme() {
      if (state.forceDarkTheme) {
        document.documentElement.setAttribute('data-theme', 'dark');
      } else {
        document.documentElement.removeAttribute('data-theme');
      }
    }

    function setPanelOpen(panel, trigger, isOpen) {
      panel.classList.toggle('open', isOpen);
      panel.setAttribute('aria-hidden', String(!isOpen));
      trigger.setAttribute('aria-expanded', String(isOpen));
    }

    function togglePanel(panel, trigger) {
      const isOpen = !panel.classList.contains('open');
      setPanelOpen(panel, trigger, isOpen);
    }

    function moveStep(index, direction) {
      const routine = currentRoutine();
      const target = index + direction;
      if (target < 0 || target >= routine.length) return;

      [routine[index], routine[target]] = [routine[target], routine[index]];

      if (state.stepIndex === index) state.stepIndex = target;
      else if (state.stepIndex === target) state.stepIndex = index;

      saveSettings();
      render();
    }

    function updateStepDuration(index, value) {
      const seconds = Math.max(5, Math.min(600, Number(value) || 30));
      const routine = currentRoutine();
      routine[index].seconds = seconds;

      if (index === state.stepIndex) {
        state.remaining = Math.min(state.remaining, seconds) || seconds;
      }

      saveSettings();
      render();
    }

    function buildStepList() {
      const routine = currentRoutine();
      els.stepList.innerHTML = '';

      routine.forEach((step, index) => {
        const li = document.createElement('li');
        li.className = `list-item${index === state.stepIndex ? ' active' : ''}`;

        const info = document.createElement('div');
        const name = document.createElement('div');
        name.className = 'step-name';
        name.textContent = `${index + 1}. ${step.label}`;

        const jump = document.createElement('button');
        jump.type = 'button';
        jump.textContent = 'Jump to step';
        jump.addEventListener('click', () => {
          state.stepIndex = index;
          state.remaining = currentStep().seconds;
          state.completed = false;
          render();
          if (state.isRunning) startTicker();
        });

        info.appendChild(name);
        info.appendChild(jump);

        const actions = document.createElement('div');
        actions.className = 'item-actions';

        const durationInput = document.createElement('input');
        durationInput.type = 'number';
        durationInput.min = '5';
        durationInput.max = '600';
        durationInput.step = '5';
        durationInput.value = String(step.seconds);
        durationInput.setAttribute('aria-label', `Duration in seconds for ${step.label}`);
        durationInput.addEventListener('change', () => updateStepDuration(index, durationInput.value));

        const upBtn = document.createElement('button');
        upBtn.type = 'button';
        upBtn.textContent = '‚Üë Up';
        upBtn.disabled = index === 0;
        upBtn.addEventListener('click', () => moveStep(index, -1));

        const downBtn = document.createElement('button');
        downBtn.type = 'button';
        downBtn.textContent = '‚Üì Down';
        downBtn.disabled = index === routine.length - 1;
        downBtn.addEventListener('click', () => moveStep(index, 1));

        const resetBtn = document.createElement('button');
        resetBtn.type = 'button';
        resetBtn.textContent = 'Reset';
        resetBtn.addEventListener('click', () => {
          const defaults = DEFAULT_ROUTINES[state.mode];
          routine[index].seconds = defaults[index]?.seconds || 30;
          saveSettings();
          render();
        });

        actions.append(durationInput, upBtn, downBtn, resetBtn);
        li.append(info, actions);
        els.stepList.appendChild(li);
      });
    }

    function renderCompletion() {
      els.completionCard.classList.toggle('visible', state.completed);
      if (state.completed) {
        els.completionSummary.textContent = `Great work! Total time stretched: ${formatClock(state.completionSeconds)}.`;
      }
    }

    function render() {
      const routine = currentRoutine();
      const step = currentStep();
      const stepElapsed = step.seconds - state.remaining;
      const stepFraction = step.seconds ? stepElapsed / step.seconds : 0;
      const routineProgress = ((state.stepIndex + Math.max(0, Math.min(1, stepFraction))) / routine.length) * 100;
      const safeProgress = Math.max(0, Math.min(100, routineProgress));

      els.timer.textContent = formatClock(state.remaining);
      els.currentStep.textContent = `${step.label}`;
      els.stepTitle.textContent = `${step.label}`;
      els.headerStep.textContent = state.isRunning ? 'Keep breathing and stay tall.' : 'Ready when you are.';
      els.headerRemaining.textContent = `${formatClock(remainingTotalSeconds())} left`;
      els.totals.textContent = `Total remaining: ${formatClock(remainingTotalSeconds())}`;
      els.routineDuration.textContent = `Routine duration: ${formatClock(routineTotalSeconds())}`;
      els.progressFill.style.width = `${safeProgress}%`;
      els.stepProgressText.textContent = `Step ${state.stepIndex + 1} of ${routine.length}`;
      els.stepProgressPercent.textContent = `${Math.round(safeProgress)}%`;
      els.status.textContent = state.completed ? 'Routine complete' : state.isRunning ? 'Running' : 'Paused';
      els.modeCaption.textContent = `Mode: ${state.mode === 'quick' ? 'Quick stretch' : 'Full routine'}`;

      els.startPauseBtn.textContent = state.isRunning ? '‚è∏ Pause' : '‚ñ∂ Start';
      els.autoAdvanceToggle.checked = state.autoAdvance;
      els.vibrateToggle.checked = state.vibrate;
      els.soundToggle.checked = state.soundOn;
      els.themeToggle.checked = state.forceDarkTheme;
      els.quickModeToggle.checked = state.mode === 'quick';

      renderCompletion();
      buildStepList();
      applyTheme();
    }

    function showCompletion() {
      stopTicker();
      state.completed = true;
      state.completionSeconds = routineTotalSeconds();
      state.remaining = 0;
      buzz([80, 30, 120]);
      playStepTone();
      render();
    }

    function nextStep(fromAuto = false) {
      const routine = currentRoutine();
      if (state.stepIndex < routine.length - 1) {
        state.stepIndex += 1;
        state.remaining = currentStep().seconds;
        state.completed = false;
        if (!fromAuto) {
          buzz(80);
          playStepTone();
        }
        render();
        if (state.isRunning || fromAuto) startTicker();
      } else {
        showCompletion();
      }
    }

    function previousStep() {
      if (state.stepIndex > 0) {
        state.stepIndex -= 1;
        state.remaining = currentStep().seconds;
        state.completed = false;
        buzz(70);
        playStepTone();
        render();
        if (state.isRunning) startTicker();
      }
    }

    function onStepFinished() {
      buzz(120);
      playStepTone();
      if (state.autoAdvance) {
        nextStep(true);
      } else {
        stopTicker();
        state.remaining = currentStep().seconds;
        render();
      }
    }

    function startTicker() {
      state.completed = false;
      stopTicker();
      state.isRunning = true;
      state.endsAt = Date.now() + state.remaining * 1000;

      state.ticker = setInterval(() => {
        const secondsLeft = Math.max(0, Math.ceil((state.endsAt - Date.now()) / 1000));
        state.remaining = secondsLeft;
        render();
        if (secondsLeft <= 0) onStepFinished();
      }, 200);
    }

    function resetRoutine() {
      stopTicker();
      state.stepIndex = 0;
      state.remaining = currentStep().seconds;
      state.completed = false;
      render();
    }

    function switchMode(mode) {
      if (state.mode === mode) return;
      state.mode = mode;
      state.stepIndex = 0;
      state.remaining = currentStep().seconds;
      state.completed = false;
      stopTicker();
      saveSettings();
      render();
    }

    els.startPauseBtn.addEventListener('click', () => {
      if (state.isRunning) {
        stopTicker();
        render();
      } else {
        startTicker();
      }
    });

    els.nextBtn.addEventListener('click', () => nextStep(false));
    els.backBtn.addEventListener('click', previousStep);
    els.resetBtn.addEventListener('click', resetRoutine);
    els.restartStepBtn.addEventListener('click', () => {
      state.remaining = currentStep().seconds;
      state.completed = false;
      render();
      if (state.isRunning) startTicker();
    });

    els.startAgainBtn.addEventListener('click', () => {
      state.stepIndex = 0;
      state.remaining = currentStep().seconds;
      state.completed = false;
      render();
    });

    els.routineToggle.addEventListener('click', () => togglePanel(els.routinePanel, els.routineToggle));
    els.settingsToggle.addEventListener('click', () => togglePanel(els.settingsPanel, els.settingsToggle));

    els.autoAdvanceToggle.addEventListener('change', () => {
      state.autoAdvance = els.autoAdvanceToggle.checked;
      saveSettings();
    });

    els.vibrateToggle.addEventListener('change', () => {
      state.vibrate = els.vibrateToggle.checked;
      saveSettings();
    });

    els.soundToggle.addEventListener('change', () => {
      state.soundOn = els.soundToggle.checked;
      saveSettings();
      if (state.soundOn) playStepTone();
    });

    els.themeToggle.addEventListener('change', () => {
      state.forceDarkTheme = els.themeToggle.checked;
      saveSettings();
      applyTheme();
    });

    els.quickModeToggle.addEventListener('change', () => {
      switchMode(els.quickModeToggle.checked ? 'quick' : 'full');
    });

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
      });
    }

    loadSettings();
    applyTheme();
    state.remaining = currentStep().seconds;
    setPanelOpen(els.routinePanel, els.routineToggle, false);
    setPanelOpen(els.settingsPanel, els.settingsToggle, false);
    render();
  </script>
</body>
</html>
