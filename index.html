<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Stretch Timer" />
  <title>Stretch Timer</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="manifest.json" />
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f3f4f6;
      --surface: #ffffff;
      --surface-secondary: #edf2f7;
      --text: #111827;
      --text-muted: #5b6472;
      --border: rgba(17, 24, 39, 0.14);
      --accent: #0ea5e9;
      --accent-strong: #0284c7;
      --ok: #10b981;
      --danger: #ef4444;
      --ring-track: rgba(14, 165, 233, 0.2);
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
      --radius-card: 20px;
      --radius-control: 14px;
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 24px;
      --title: clamp(1.1rem, 2.6vw, 1.28rem);
      --subtitle: clamp(1rem, 2vw, 1.06rem);
      --body: 0.95rem;
      --caption: 0.82rem;
    }

    :root[data-theme="dark"] {
      --bg: #030712;
      --surface: #111827;
      --surface-secondary: #1f2937;
      --text: #f9fafb;
      --text-muted: #9ca3af;
      --border: rgba(156, 163, 175, 0.28);
      --accent: #38bdf8;
      --accent-strong: #0ea5e9;
      --ok: #34d399;
      --danger: #f87171;
      --ring-track: rgba(56, 189, 248, 0.22);
      --shadow-soft: 0 10px 30px rgba(2, 6, 23, 0.46);
    }

    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) {
        --bg: #030712;
        --surface: #111827;
        --surface-secondary: #1f2937;
        --text: #f9fafb;
        --text-muted: #9ca3af;
        --border: rgba(156, 163, 175, 0.28);
        --accent: #38bdf8;
        --accent-strong: #0ea5e9;
        --ok: #34d399;
        --danger: #f87171;
        --ring-track: rgba(56, 189, 248, 0.22);
        --shadow-soft: 0 10px 30px rgba(2, 6, 23, 0.46);
      }
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      min-height: 100dvh;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: var(--body);
    }

    .app {
      max-width: 980px;
      margin: 0 auto;
      padding: calc(var(--space-3) + env(safe-area-inset-top)) var(--space-3) calc(var(--space-5) + env(safe-area-inset-bottom));
      display: grid;
      gap: var(--space-3);
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-soft);
      padding: var(--space-4);
    }

    .bento-grid { display: grid; gap: var(--space-3); grid-template-columns: 1fr; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: var(--space-2); }
    .stack { display: grid; gap: var(--space-2); }
    .app-title { margin: 0; font-size: var(--title); letter-spacing: -0.01em; user-select: none; }
    .status { margin: 0; color: var(--text-muted); font-size: var(--caption); }
    .caption { color: var(--text-muted); font-size: var(--caption); }

    .pill {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 650;
      background: var(--surface-secondary);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    .update-banner {
      display: none;
      position: sticky;
      top: 0;
      z-index: 10;
      background: color-mix(in srgb, var(--accent) 14%, var(--surface));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .update-banner.visible { display: flex; }

    .hero { min-height: min(73dvh, 620px); align-content: space-between; }
    .timer-wrap { display: grid; place-items: center; gap: var(--space-2); }

    .timer {
      font-size: clamp(3.7rem, 17vw, 6rem);
      line-height: 1;
      font-weight: 800;
      letter-spacing: 0.03em;
      font-variant-numeric: tabular-nums;
      transition: transform 0.2s ease;
    }

    .timer.pulse { transform: scale(1.015); }

    .progress-wrap { display: grid; gap: var(--space-2); }
    .progress-label { display: flex; justify-content: space-between; gap: var(--space-2); color: var(--text-muted); font-size: var(--caption); font-weight: 630; }
    .progress-bar { height: 10px; border-radius: 999px; overflow: hidden; background: var(--ring-track); }
    .progress-bar > span { display: block; width: 0%; height: 100%; background: linear-gradient(90deg, var(--ok), var(--accent)); transition: width 0.34s ease; }

    .current-step { margin: 0; font-size: var(--subtitle); font-weight: 660; }
    .step-cue { margin: 0; color: var(--text-muted); font-size: var(--caption); }

    .controls-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: var(--space-2); }

    button, input[type="number"], select {
      border: 1px solid var(--border);
      border-radius: var(--radius-control);
      background: var(--surface-secondary);
      color: var(--text);
      font: inherit;
    }

    button {
      min-height: 52px;
      padding: 12px;
      font-weight: 680;
      cursor: pointer;
      transition: transform 0.12s ease, filter 0.2s ease, background-color 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    button:hover { filter: brightness(0.98); }
    button:active { transform: scale(0.975); }

    .primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: color-mix(in srgb, var(--accent) 72%, black);
      color: #04263f;
      font-weight: 760;
    }

    .danger { color: var(--danger); border-color: color-mix(in srgb, var(--danger) 42%, transparent); }
    .button-icon { min-height: 42px; padding: 8px 12px; border-radius: 999px; font-size: var(--caption); }

    .panel-header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: var(--space-2); }

    .collapsible {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transform: translateY(-2px);
      transition: max-height 0.3s ease, opacity 0.2s ease, transform 0.2s ease;
    }
    .collapsible.open { max-height: 1400px; opacity: 1; transform: translateY(0); margin-top: var(--space-3); }

    .settings-grid { display: grid; gap: var(--space-3); grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .setting { display: grid; gap: 8px; color: var(--text-muted); font-weight: 630; }

    .segmented {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: var(--space-2);
      padding: 4px;
      border: 1px solid var(--border);
      border-radius: var(--radius-control);
      background: var(--surface-secondary);
    }

    .segmented button { min-height: 44px; border-radius: 10px; border-color: transparent; }

    .preview-list, .list, .editor-list { list-style: none; margin: 0; padding: 0; display: grid; gap: var(--space-2); }
    .list-item {
      border: 1px solid var(--border);
      border-radius: var(--radius-control);
      padding: var(--space-3);
      display: grid;
      gap: var(--space-2);
      background: var(--surface-secondary);
    }

    .list-item.active { border-color: color-mix(in srgb, var(--accent) 58%, var(--border)); box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--accent) 44%, transparent); }
    .step-name { font-weight: 650; }
    .preview-drawer summary { cursor: pointer; font-weight: 640; }

    .duration-row { display: grid; grid-template-columns: 1fr 90px; gap: var(--space-2); align-items: center; }
    .duration-row input[type="number"] { min-height: 44px; padding: 8px; width: 100%; }

    .completion {
      display: none;
      margin-top: var(--space-2);
      text-align: center;
      border: 1px solid color-mix(in srgb, var(--ok) 38%, var(--border));
      border-radius: var(--radius-control);
      padding: var(--space-3);
      background: color-mix(in srgb, var(--ok) 10%, var(--surface));
    }
    .completion.visible { display: block; }

    .debug-panel {
      display: none;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: color-mix(in srgb, var(--surface-secondary) 80%, transparent);
      padding: 10px;
      font-size: var(--caption);
      color: var(--text-muted);
    }
    .debug-panel.visible { display: grid; gap: 6px; }

    :focus-visible { outline: 2px solid color-mix(in srgb, var(--accent) 78%, white); outline-offset: 2px; }

    @media (min-width: 860px) {
      .bento-grid {
        grid-template-columns: 1.3fr 1fr;
        grid-template-areas:
          "hero step"
          "controls summary"
          "panels panels";
      }
      .hero { grid-area: hero; }
      .step-card { grid-area: step; }
      .controls-card { grid-area: controls; }
      .summary-card { grid-area: summary; }
      .panel-card { grid-area: panels; }
    }

    @media (max-width: 760px) {
      .app { gap: var(--space-2); padding-left: var(--space-2); padding-right: var(--space-2); }
      .card { padding: var(--space-3); }
      .hero { min-height: min(74dvh, 580px); }
      .controls-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
  </style>
</head>
<body>
  <main class="app">
    <section id="updateBanner" class="update-banner" role="status" aria-live="polite">
      <span>Update available.</span>
      <button id="reloadBtn" type="button" class="primary" aria-label="Reload with latest version">Reload</button>
    </section>

    <section class="bento-grid">
      <article class="card hero stack" aria-label="Main timer">
        <div class="row">
          <div>
            <h1 id="headerTitle" class="app-title">Stretch Timer</h1>
            <p class="status" id="status">Ready to start</p>
          </div>
          <div class="row">
            <button id="debugToggleBtn" class="button-icon" type="button" aria-label="Toggle diagnostics">i</button>
            <div class="pill" id="headerRemaining">--:-- left</div>
          </div>
        </div>

        <div class="timer-wrap">
          <div id="timer" class="timer" aria-live="polite">00:00</div>
          <p id="currentStep" class="current-step">Press Start to begin.</p>
          <p class="step-cue" id="headerStep">Current stretch</p>
        </div>

        <div class="progress-wrap">
          <div class="progress-label">
            <span id="stepProgressText">Step 1 of 1</span>
            <span id="stepProgressPercent">0%</span>
          </div>
          <div class="progress-bar" aria-label="Progress through current routine">
            <span id="progressFill"></span>
          </div>
        </div>

        <button id="startPauseBtn" type="button" class="primary" aria-label="Start or pause timer">‚ñ∂ Start</button>
      </article>

      <article class="card step-card stack">
        <div class="caption">Current stretch</div>
        <p id="stepTitle" class="current-step">Press Start to begin.</p>
        <p id="modeCaption" class="caption">Mode: Long routine</p>
      </article>

      <article class="card controls-card stack">
        <div class="caption">Controls</div>
        <div class="controls-grid">
          <button id="backBtn" type="button" aria-label="Previous stretch">‚èÆ Back</button>
          <button id="nextBtn" type="button" aria-label="Next stretch">Next ‚è≠</button>
          <button id="restartStepBtn" type="button" aria-label="Restart current stretch">‚Ü∫ Restart</button>
          <button id="resetBtn" type="button" class="danger" aria-label="Reset routine">Reset</button>
        </div>
      </article>

      <article class="card summary-card stack">
        <div class="caption">Routine summary</div>
        <div class="pill" id="totals">Total remaining: --:--</div>
        <div class="pill" id="routineDuration">Routine duration: --:--</div>
        <details class="preview-drawer">
          <summary>Upcoming (next 3)</summary>
          <ul id="previewList" class="preview-list"></ul>
        </details>
      </article>

      <article class="card panel-card stack">
        <div class="panel-header">
          <div class="caption">More</div>
          <div class="row">
            <button id="routineToggle" class="button-icon" type="button" aria-expanded="false" aria-controls="routinePanel">Routine</button>
            <button id="settingsToggle" class="button-icon" type="button" aria-expanded="false" aria-controls="settingsPanel">Settings</button>
          </div>
        </div>

        <section id="routinePanel" class="collapsible" aria-hidden="true">
          <p class="caption" style="margin:0 0 8px;">View steps and jump to any step.</p>
          <ul id="stepList" class="list"></ul>
        </section>

        <section id="settingsPanel" class="collapsible" aria-hidden="true">
          <div class="settings-grid">
            <div class="setting">
              Routine
              <div class="segmented" role="radiogroup" aria-label="Select routine length" id="routineSegmented">
                <button type="button" data-routine-key="quick" role="radio" aria-checked="false">Quick</button>
                <button type="button" data-routine-key="long" role="radio" aria-checked="true">Long</button>
              </div>
            </div>
            <label class="setting" for="themeSelect">
              Theme
              <select id="themeSelect" aria-label="Theme" class="setting-select">
                <option value="system">System</option>
                <option value="light">Light</option>
                <option value="dark">Dark</option>
              </select>
            </label>
            <div class="setting">
              Version
              <div id="versionLabel" class="pill">--</div>
            </div>
          </div>
          <div class="setting" style="margin-top:12px;">
            Edit durations (seconds)
            <ul id="durationEditor" class="editor-list"></ul>
            <button id="resetDurationsBtn" type="button">Reset durations to defaults</button>
          </div>
        </section>

        <section id="debugPanel" class="debug-panel" aria-live="polite"></section>

        <div id="completionCard" class="completion" aria-live="polite">
          <h2>Routine complete üéâ</h2>
          <p id="completionSummary"></p>
          <button id="startAgainBtn" type="button" class="primary">Start again</button>
        </div>
      </article>
    </section>
  </main>

  <script>
    const APP_VERSION = 'vNext-2026.02.17';
    const STORAGE_KEY = 'stretch-timer-settings-vnext';

    const BASE_ROUTINES = {
      long: [
        { label: 'Left Half-Kneeling Hip Flexor', seconds: 75 },
        { label: 'Right Half-Kneeling Hip Flexor', seconds: 75 },
        { label: 'Left Couch Stretch', seconds: 75 },
        { label: 'Right Couch Stretch', seconds: 75 },
        { label: 'Left Pigeon Pose', seconds: 75 },
        { label: 'Right Pigeon Pose', seconds: 75 },
        { label: 'Left Hamstring Stretch', seconds: 75 },
        { label: 'Right Hamstring Stretch', seconds: 75 },
        { label: 'Adductor Rock-Back', seconds: 60 },
        { label: 'Calf Stretch (Wall)', seconds: 60 },
        { label: 'Thoracic Opener (Open Book)', seconds: 60 },
        { label: 'Child‚Äôs Pose', seconds: 60 },
        { label: 'Supine Spinal Twist (Left)', seconds: 60 },
        { label: 'Supine Spinal Twist (Right)', seconds: 60 }
      ],
      quick: [
        { label: 'Left Half-Kneeling Hip Flexor', seconds: 60 },
        { label: 'Right Half-Kneeling Hip Flexor', seconds: 60 },
        { label: 'Left Pigeon Pose', seconds: 60 },
        { label: 'Right Pigeon Pose', seconds: 60 },
        { label: 'Left Hamstring Stretch', seconds: 60 },
        { label: 'Right Hamstring Stretch', seconds: 60 },
        { label: 'Chest Opener (Doorway)', seconds: 60 },
        { label: 'Thoracic Opener (Open Book)', seconds: 60 },
        { label: 'Child‚Äôs Pose', seconds: 60 }
      ]
    };

    const els = {
      timer: document.getElementById('timer'),
      currentStep: document.getElementById('currentStep'),
      stepTitle: document.getElementById('stepTitle'),
      totals: document.getElementById('totals'),
      routineDuration: document.getElementById('routineDuration'),
      status: document.getElementById('status'),
      progressFill: document.getElementById('progressFill'),
      stepProgressText: document.getElementById('stepProgressText'),
      stepProgressPercent: document.getElementById('stepProgressPercent'),
      headerStep: document.getElementById('headerStep'),
      headerRemaining: document.getElementById('headerRemaining'),
      modeCaption: document.getElementById('modeCaption'),
      stepList: document.getElementById('stepList'),
      previewList: document.getElementById('previewList'),
      completionCard: document.getElementById('completionCard'),
      completionSummary: document.getElementById('completionSummary'),
      routineToggle: document.getElementById('routineToggle'),
      settingsToggle: document.getElementById('settingsToggle'),
      routinePanel: document.getElementById('routinePanel'),
      settingsPanel: document.getElementById('settingsPanel'),
      routineButtons: Array.from(document.querySelectorAll('[data-routine-key]')),
      startPauseBtn: document.getElementById('startPauseBtn'),
      nextBtn: document.getElementById('nextBtn'),
      backBtn: document.getElementById('backBtn'),
      resetBtn: document.getElementById('resetBtn'),
      restartStepBtn: document.getElementById('restartStepBtn'),
      startAgainBtn: document.getElementById('startAgainBtn'),
      themeSelect: document.getElementById('themeSelect'),
      durationEditor: document.getElementById('durationEditor'),
      resetDurationsBtn: document.getElementById('resetDurationsBtn'),
      updateBanner: document.getElementById('updateBanner'),
      reloadBtn: document.getElementById('reloadBtn'),
      debugPanel: document.getElementById('debugPanel'),
      debugToggleBtn: document.getElementById('debugToggleBtn'),
      headerTitle: document.getElementById('headerTitle'),
      versionLabel: document.getElementById('versionLabel')
    };

    const state = {
      activeRoutineKey: 'long',
      stepIndex: 0,
      remaining: 0,
      isRunning: false,
      theme: 'system',
      ticker: null,
      endsAt: 0,
      completed: false,
      completionSeconds: 0,
      routines: structuredClone(BASE_ROUTINES),
      durations: { quick: [], long: [] },
      swRegistered: false,
      debugOpen: false
    };

    function formatClock(totalSeconds) {
      const s = Math.max(0, Math.floor(totalSeconds));
      const min = Math.floor(s / 60).toString().padStart(2, '0');
      const sec = (s % 60).toString().padStart(2, '0');
      return `${min}:${sec}`;
    }

    function currentRoutine() { return state.routines[state.activeRoutineKey]; }
    function currentStep() { return currentRoutine()[state.stepIndex]; }
    function routineTotalSeconds() { return currentRoutine().reduce((sum, step) => sum + step.seconds, 0); }

    function remainingTotalSeconds() {
      const routine = currentRoutine();
      return routine.slice(state.stepIndex + 1).reduce((sum, step) => sum + step.seconds, 0) + state.remaining;
    }

    function persistSettings() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        theme: state.theme,
        activeRoutineKey: state.activeRoutineKey,
        durations: state.durations
      }));
    }

    function applyDurationOverrides(overrides) {
      ['quick', 'long'].forEach((key) => {
        const list = BASE_ROUTINES[key];
        const provided = Array.isArray(overrides?.[key]) ? overrides[key] : [];
        state.durations[key] = list.map((step, idx) => {
          const value = Number(provided[idx]);
          return Number.isFinite(value) ? Math.min(600, Math.max(15, Math.round(value))) : step.seconds;
        });
        state.routines[key] = list.map((step, idx) => ({ ...step, seconds: state.durations[key][idx] }));
      });
    }

    function loadSettings() {
      applyDurationOverrides(null);
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed.theme === 'system' || parsed.theme === 'light' || parsed.theme === 'dark') state.theme = parsed.theme;
        if (parsed.activeRoutineKey === 'quick' || parsed.activeRoutineKey === 'long') state.activeRoutineKey = parsed.activeRoutineKey;
        applyDurationOverrides(parsed.durations);
      } catch (_) {}
    }

    function stopTicker() {
      if (state.ticker) clearInterval(state.ticker);
      state.ticker = null;
      state.isRunning = false;
    }

    function applyTheme() {
      if (state.theme === 'system') return document.documentElement.removeAttribute('data-theme');
      document.documentElement.setAttribute('data-theme', state.theme);
    }

    function setPanelOpen(panel, trigger, isOpen) {
      panel.classList.toggle('open', isOpen);
      panel.setAttribute('aria-hidden', String(!isOpen));
      trigger.setAttribute('aria-expanded', String(isOpen));
    }

    function iconSvg() {
      return '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 4l3 6 3 1 2 6"></path><path d="M8 19h8"></path></svg>';
    }

    function stepWithIconHtml(label, prefix = '') {
      return `<span style="display:inline-flex;align-items:center;gap:8px;"><span aria-hidden="true" style="width:1.1em;height:1.1em;color:var(--accent-strong);display:inline-block;">${iconSvg()}</span><span>${prefix}${label}</span></span>`;
    }

    function buildStepList() {
      const routine = currentRoutine();
      els.stepList.innerHTML = '';
      routine.forEach((step, index) => {
        const li = document.createElement('li');
        li.className = `list-item${index === state.stepIndex ? ' active' : ''}`;
        const name = document.createElement('div');
        name.className = 'step-name';
        name.innerHTML = stepWithIconHtml(step.label, `${index + 1}. `);
        const jump = document.createElement('button');
        jump.type = 'button';
        jump.textContent = 'Jump to step';
        jump.addEventListener('click', () => {
          state.stepIndex = index;
          state.remaining = currentStep().seconds;
          state.completed = false;
          render();
          if (state.isRunning) startTicker();
        });
        const duration = document.createElement('div');
        duration.className = 'caption';
        duration.textContent = formatClock(step.seconds);
        li.append(name, jump, duration);
        els.stepList.appendChild(li);
      });
    }

    function buildPreview() {
      const routine = currentRoutine();
      const upcoming = routine.slice(state.stepIndex + 1, state.stepIndex + 4);
      els.previewList.innerHTML = '';
      if (!upcoming.length) {
        const li = document.createElement('li');
        li.className = 'caption';
        li.textContent = 'No upcoming steps.';
        els.previewList.appendChild(li);
        return;
      }
      upcoming.forEach((step) => {
        const li = document.createElement('li');
        li.className = 'list-item';
        li.textContent = `${step.label} ¬∑ ${formatClock(step.seconds)}`;
        els.previewList.appendChild(li);
      });
    }

    function buildDurationEditor() {
      els.durationEditor.innerHTML = '';
      currentRoutine().forEach((step, index) => {
        const li = document.createElement('li');
        li.className = 'duration-row';
        const label = document.createElement('label');
        label.textContent = step.label;
        label.setAttribute('for', `duration-${index}`);

        const input = document.createElement('input');
        input.type = 'number';
        input.id = `duration-${index}`;
        input.min = '15';
        input.max = '600';
        input.step = '5';
        input.value = String(step.seconds);
        input.setAttribute('aria-label', `${step.label} duration in seconds`);
        input.addEventListener('change', () => {
          const safe = Math.min(600, Math.max(15, Math.round(Number(input.value) || step.seconds)));
          state.durations[state.activeRoutineKey][index] = safe;
          state.routines[state.activeRoutineKey][index].seconds = safe;
          if (state.stepIndex === index) state.remaining = Math.min(state.remaining, safe) || safe;
          input.value = String(safe);
          state.completed = false;
          persistSettings();
          render();
          if (state.isRunning) startTicker();
        });

        li.append(label, input);
        els.durationEditor.appendChild(li);
      });
    }

    function renderCompletion() {
      els.completionCard.classList.toggle('visible', state.completed);
      if (state.completed) els.completionSummary.textContent = `Great work! Total time stretched: ${formatClock(state.completionSeconds)}.`;
    }

    function updateDebugPanel() {
      if (!state.debugOpen) return;
      const lines = [
        `mode: ${state.activeRoutineKey}`,
        `theme: ${state.theme}`,
        `sw registered: ${state.swRegistered ? 'yes' : 'no'}`,
        `cache version: stretch-timer-vnext-2026-02-17`,
        `app version: ${APP_VERSION}`
      ];
      els.debugPanel.innerHTML = lines.map((line) => `<div>${line}</div>`).join('');
    }

    function render() {
      const routine = currentRoutine();
      const step = currentStep();
      const stepElapsed = step.seconds - state.remaining;
      const stepFraction = step.seconds ? stepElapsed / step.seconds : 0;
      const routineProgress = ((state.stepIndex + Math.max(0, Math.min(1, stepFraction))) / routine.length) * 100;
      const safeProgress = Math.max(0, Math.min(100, routineProgress));

      els.timer.textContent = formatClock(state.remaining);
      els.timer.classList.toggle('pulse', state.isRunning);
      els.currentStep.innerHTML = stepWithIconHtml(step.label);
      els.stepTitle.innerHTML = stepWithIconHtml(step.label);
      els.headerStep.textContent = state.isRunning ? 'Keep breathing and stay tall.' : 'Ready when you are.';
      els.headerRemaining.textContent = `${formatClock(remainingTotalSeconds())} left`;
      els.totals.textContent = `Total remaining: ${formatClock(remainingTotalSeconds())}`;
      els.routineDuration.textContent = `Routine duration: ${formatClock(routineTotalSeconds())}`;
      els.progressFill.style.width = `${safeProgress}%`;
      els.stepProgressText.textContent = `Step ${state.stepIndex + 1} of ${routine.length}`;
      els.stepProgressPercent.textContent = `${Math.round(safeProgress)}%`;
      els.status.textContent = state.completed ? 'Routine complete' : state.isRunning ? 'Running' : 'Paused';
      els.modeCaption.textContent = `Mode: ${state.activeRoutineKey === 'quick' ? 'Quick routine' : 'Long routine'}`;
      els.startPauseBtn.textContent = state.isRunning ? '‚è∏ Pause' : '‚ñ∂ Start';
      els.themeSelect.value = state.theme;
      els.versionLabel.textContent = APP_VERSION;

      els.routineButtons.forEach((button) => {
        const isActive = button.dataset.routineKey === state.activeRoutineKey;
        button.classList.toggle('primary', isActive);
        button.setAttribute('aria-pressed', String(isActive));
        button.setAttribute('aria-checked', String(isActive));
        button.tabIndex = isActive ? 0 : -1;
      });

      buildStepList();
      buildPreview();
      buildDurationEditor();
      renderCompletion();
      applyTheme();
      updateDebugPanel();
    }

    function showCompletion() {
      stopTicker();
      state.completed = true;
      state.completionSeconds = routineTotalSeconds();
      state.remaining = 0;
      render();
    }

    function nextStep(fromAuto = false) {
      const routine = currentRoutine();
      if (state.stepIndex < routine.length - 1) {
        state.stepIndex += 1;
        state.remaining = currentStep().seconds;
        state.completed = false;
        render();
        if (state.isRunning || fromAuto) startTicker();
      } else {
        showCompletion();
      }
    }

    function previousStep() {
      if (state.stepIndex > 0) {
        state.stepIndex -= 1;
        state.remaining = currentStep().seconds;
        state.completed = false;
        render();
        if (state.isRunning) startTicker();
      }
    }

    function startTicker() {
      state.completed = false;
      stopTicker();
      state.isRunning = true;
      state.endsAt = Date.now() + state.remaining * 1000;

      state.ticker = setInterval(() => {
        const secondsLeft = Math.max(0, Math.ceil((state.endsAt - Date.now()) / 1000));
        state.remaining = secondsLeft;
        render();
        if (secondsLeft <= 0) nextStep(true);
      }, 220);
    }

    function resetRoutine() {
      stopTicker();
      state.stepIndex = 0;
      state.remaining = currentStep().seconds;
      state.completed = false;
      render();
    }

    function switchMode(mode) {
      if (mode !== 'quick' && mode !== 'long') return;
      if (state.activeRoutineKey === mode) return;
      state.activeRoutineKey = mode;
      stopTicker();
      state.stepIndex = 0;
      state.remaining = currentStep().seconds;
      state.completed = false;
      persistSettings();
      render();
    }

    function setupSegmentedKeyboard() {
      const seg = document.getElementById('routineSegmented');
      seg.addEventListener('keydown', (event) => {
        if (!['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(event.key)) return;
        event.preventDefault();
        const order = ['quick', 'long'];
        const currentIdx = order.indexOf(state.activeRoutineKey);
        const dir = (event.key === 'ArrowRight' || event.key === 'ArrowDown') ? 1 : -1;
        const nextMode = order[(currentIdx + dir + order.length) % order.length];
        switchMode(nextMode);
        const target = els.routineButtons.find((b) => b.dataset.routineKey === nextMode);
        if (target) target.focus();
      });
    }

    function showUpdateBanner(registration) {
      if (!registration?.waiting) return;
      els.updateBanner.classList.add('visible');
      els.reloadBtn.onclick = () => {
        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
      };
    }

    function setupServiceWorker() {
      if (!('serviceWorker' in navigator)) return;
      if (location.hostname === '127.0.0.1' || location.hostname === 'localhost') return;
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('./sw.js');
          state.swRegistered = true;
          updateDebugPanel();

          if (registration.waiting) showUpdateBanner(registration);

          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            if (!newWorker) return;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showUpdateBanner(registration);
              }
            });
          });

          navigator.serviceWorker.addEventListener('controllerchange', () => {
            window.location.reload();
          });
        } catch (_) {
          state.swRegistered = false;
          updateDebugPanel();
        }
      });
    }

    els.startPauseBtn.addEventListener('click', () => {
      if (state.isRunning) {
        stopTicker();
        render();
      } else {
        startTicker();
      }
    });

    els.nextBtn.addEventListener('click', () => nextStep(false));
    els.backBtn.addEventListener('click', previousStep);
    els.resetBtn.addEventListener('click', resetRoutine);
    els.restartStepBtn.addEventListener('click', () => {
      state.remaining = currentStep().seconds;
      state.completed = false;
      render();
      if (state.isRunning) startTicker();
    });

    els.startAgainBtn.addEventListener('click', () => {
      state.stepIndex = 0;
      state.remaining = currentStep().seconds;
      state.completed = false;
      render();
    });

    els.routineToggle.addEventListener('click', () => setPanelOpen(els.routinePanel, els.routineToggle, !els.routinePanel.classList.contains('open')));
    els.settingsToggle.addEventListener('click', () => setPanelOpen(els.settingsPanel, els.settingsToggle, !els.settingsPanel.classList.contains('open')));

    els.themeSelect.addEventListener('change', () => {
      state.theme = els.themeSelect.value;
      persistSettings();
      applyTheme();
      render();
    });

    els.routineButtons.forEach((button) => button.addEventListener('click', () => switchMode(button.dataset.routineKey)));

    els.resetDurationsBtn.addEventListener('click', () => {
      applyDurationOverrides(null);
      state.stepIndex = 0;
      state.remaining = currentStep().seconds;
      state.completed = false;
      persistSettings();
      render();
    });

    els.debugToggleBtn.addEventListener('click', () => {
      state.debugOpen = !state.debugOpen;
      els.debugPanel.classList.toggle('visible', state.debugOpen);
      updateDebugPanel();
    });

    let longPressTimer = null;
    els.headerTitle.addEventListener('pointerdown', () => {
      longPressTimer = setTimeout(() => {
        state.debugOpen = !state.debugOpen;
        els.debugPanel.classList.toggle('visible', state.debugOpen);
        updateDebugPanel();
      }, 700);
    });
    ['pointerup', 'pointercancel', 'pointerleave'].forEach((evt) => {
      els.headerTitle.addEventListener(evt, () => {
        if (longPressTimer) clearTimeout(longPressTimer);
      });
    });

    loadSettings();
    setupSegmentedKeyboard();
    setupServiceWorker();
    state.remaining = currentStep().seconds;
    setPanelOpen(els.routinePanel, els.routineToggle, false);
    setPanelOpen(els.settingsPanel, els.settingsToggle, false);
    render();
  </script>
</body>
</html>
