<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#faf8f5" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#0e0e0c" media="(prefers-color-scheme: dark)" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Stretch" />
  <title>Stretch Timer</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Jost:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    /* ‚îÄ‚îÄ TOKENS ‚îÄ‚îÄ */
    :root {
      --bg:        #faf8f5;
      --surface:   #ffffff;
      --surface2:  #f2efe9;
      --text:      #1c1b18;
      --muted:     #7a7870;
      --border:    rgba(28,27,24,0.10);
      --accent:    #b85c2a;
      --accent2:   #e07a45;
      --accent-bg: #f5e8df;
      --rest:      #3a7a6a;
      --rest-bg:   #ddf0ea;
      --shadow:    0 2px 16px rgba(28,27,24,0.07);
      --radius:    20px;
      --ff-serif:  'Lora', Georgia, serif;
      --ff-sans:   'Jost', sans-serif;
    }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) {
        --bg:#0e0e0c; --surface:#1a1a16; --surface2:#242420;
        --text:#f0ede6; --muted:#7a7870; --border:rgba(240,237,230,0.10);
        --accent:#e07a45; --accent2:#f0a070; --accent-bg:#2e1c10;
        --rest:#5aaa90; --rest-bg:#0e2820; --shadow:0 2px 20px rgba(0,0,0,0.35);
      }
    }
    :root[data-theme="dark"] {
      --bg:#0e0e0c; --surface:#1a1a16; --surface2:#242420;
      --text:#f0ede6; --muted:#7a7870; --border:rgba(240,237,230,0.10);
      --accent:#e07a45; --accent2:#f0a070; --accent-bg:#2e1c10;
      --rest:#5aaa90; --rest-bg:#0e2820; --shadow:0 2px 20px rgba(0,0,0,0.35);
    }
    :root[data-theme="light"] {
      --bg:#faf8f5; --surface:#ffffff; --surface2:#f2efe9;
      --text:#1c1b18; --muted:#7a7870; --border:rgba(28,27,24,0.10);
      --accent:#b85c2a; --accent2:#e07a45; --accent-bg:#f5e8df;
      --rest:#3a7a6a; --rest-bg:#ddf0ea; --shadow:0 2px 16px rgba(28,27,24,0.07);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: var(--ff-sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      font-size: 15px;
      transition: background 0.25s, color 0.25s;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: calc(16px + env(safe-area-inset-top)) 18px calc(32px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Update banner */
    #updateBanner {
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: var(--accent-bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 14px;
      font-size: 0.82rem;
      position: sticky;
      top: 8px;
      z-index: 20;
    }
    #updateBanner.visible { display: flex; }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0 2px;
    }
    .wordmark { font-family: var(--ff-serif); font-size: 1.35rem; letter-spacing: -0.02em; user-select: none; }
    .wordmark em { color: var(--accent); font-style: italic; }
    .header-right { display: flex; align-items: center; gap: 8px; }
    .icon-btn {
      width: 36px; height: 36px; border-radius: 50%;
      border: 1px solid var(--border); background: var(--surface);
      color: var(--muted); font-size: 0.82rem; font-family: var(--ff-sans);
      font-weight: 500; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow); transition: transform 0.12s;
    }
    .icon-btn:active { transform: scale(0.92); }
    .pill-remaining {
      font-size: 0.75rem; font-weight: 500; color: var(--muted);
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 999px; padding: 5px 10px;
      font-variant-numeric: tabular-nums; white-space: nowrap;
    }

    /* Tabs */
    .tabs {
      display: grid; grid-template-columns: repeat(3,1fr);
      background: var(--surface2); border-radius: 14px;
      padding: 4px; border: 1px solid var(--border);
    }
    .tab {
      padding: 9px 4px; border: none; border-radius: 10px;
      background: none; font-family: var(--ff-sans);
      font-size: 0.82rem; font-weight: 500; color: var(--muted);
      cursor: pointer; transition: all 0.2s; letter-spacing: 0.01em;
    }
    .tab.active { background: var(--surface); color: var(--text); box-shadow: 0 1px 6px rgba(0,0,0,0.08); }

    /* Pages */
    .page { display: none; flex-direction: column; gap: 12px; }
    .page.active { display: flex; }

    /* Cards */
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; }
    .card-title { font-size: 0.72rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 14px; }

    /* Timer hero */
    .timer-hero { display: flex; flex-direction: column; align-items: center; padding: 24px 20px 20px; }
    .step-name-display { font-family: var(--ff-serif); font-size: 1.3rem; font-weight: 600; text-align: center; line-height: 1.25; margin-bottom: 4px; }
    .step-cue-display { font-size: 0.8rem; color: var(--muted); text-align: center; margin-bottom: 0; }

    /* Ring */
    .ring-wrap {
      position: relative; width: min(240px,65vw); height: min(240px,65vw);
      margin: 14px 0 20px;
    }
    .ring-wrap svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .ring-bg { fill: none; stroke: var(--surface2); stroke-width: 9; }
    .ring-fg {
      fill: none; stroke: var(--accent); stroke-width: 9; stroke-linecap: round;
      stroke-dasharray: 263.89; stroke-dashoffset: 0;
      transition: stroke-dashoffset 0.85s linear, stroke 0.4s ease;
    }
    .ring-fg.rest-color { stroke: var(--rest); }
    .ring-center {
      position: absolute; inset: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;
    }
    .ring-time {
      font-family: var(--ff-serif); font-size: clamp(2.6rem,13vw,3.6rem);
      font-weight: 600; letter-spacing: -0.03em; font-variant-numeric: tabular-nums; line-height: 1;
    }
    .ring-phase { font-size: 0.68rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.12em; color: var(--muted); }

    /* Dots */
    .step-dots { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; max-width: 300px; }
    .dot {
      width: 9px; height: 9px; border-radius: 50%;
      background: var(--surface2); border: 1px solid var(--border);
      transition: background 0.3s, border-color 0.3s; cursor: pointer;
    }
    .dot.done { background: var(--accent); border-color: var(--accent); }
    .dot.active { background: var(--accent); border-color: var(--accent); opacity: 0.45; }
    .dot.rest-active { background: var(--rest); border-color: var(--rest); opacity: 0.5; }

    /* Progress */
    .progress-wrap { width: 100%; margin-bottom: 22px; }
    .progress-meta { display: flex; justify-content: space-between; font-size: 0.72rem; color: var(--muted); font-weight: 500; margin-bottom: 6px; }
    .progress-track { height: 5px; border-radius: 999px; background: var(--surface2); overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 999px; width: 0%; transition: width 0.5s ease; }

    /* Controls */
    .play-btn {
      width: 68px; height: 68px; border-radius: 50%;
      background: var(--accent); border: none; color: #fff; font-size: 1.4rem; cursor: pointer;
      box-shadow: 0 4px 20px rgba(184,92,42,0.35); transition: transform 0.15s, box-shadow 0.15s;
      display: flex; align-items: center; justify-content: center; margin-bottom: 16px;
    }
    .play-btn:active { transform: scale(0.93); }
    .play-btn.rest-mode { background: var(--rest); box-shadow: 0 4px 20px rgba(58,122,106,0.35); }
    .sec-controls { display: flex; gap: 10px; align-items: center; }
    .sec-btn {
      width: 48px; height: 48px; border-radius: 50%;
      border: 1px solid var(--border); background: var(--surface2); color: var(--text);
      font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: transform 0.12s;
    }
    .sec-btn:active { transform: scale(0.92); }

    /* Routine segmented */
    .routine-segmented { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
    .routine-seg-btn {
      padding: 12px 8px; border-radius: 14px; border: 2px solid var(--border);
      background: var(--surface2); font-family: var(--ff-sans); font-size: 0.85rem;
      font-weight: 500; color: var(--muted); cursor: pointer; transition: all 0.2s; text-align: center;
    }
    .routine-seg-btn.active { border-color: var(--accent); background: var(--accent-bg); color: var(--accent); font-weight: 600; }

    /* Step list */
    .step-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
    .step-list li {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 14px; border-radius: 13px;
      border: 1px solid var(--border); background: var(--surface2);
      font-size: 0.88rem; cursor: pointer; transition: border-color 0.2s, background 0.2s;
    }
    .step-list li.active-step { border-color: var(--accent); background: var(--accent-bg); }
    .step-list li:active { opacity: 0.75; }
    .step-num { font-size: 0.72rem; font-weight: 600; color: var(--muted); min-width: 18px; text-align: right; }
    .step-dur { margin-left: auto; font-size: 0.72rem; color: var(--muted); font-variant-numeric: tabular-nums; white-space: nowrap; }

    /* Settings */
    .setting-row { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
    .setting-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }
    .setting-select {
      width: 100%; padding: 11px 14px; border-radius: 12px;
      border: 1px solid var(--border); background: var(--surface2);
      color: var(--text); font-family: var(--ff-sans); font-size: 0.9rem; cursor: pointer;
    }

    /* Duration editor */
    .dur-editor { display: flex; flex-direction: column; gap: 8px; }
    .dur-row { display: grid; grid-template-columns: 1fr 80px; gap: 8px; align-items: center; }
    .dur-label { font-size: 0.82rem; color: var(--text); }
    .dur-input {
      padding: 9px 10px; border-radius: 10px; border: 1px solid var(--border);
      background: var(--surface2); color: var(--text); font-family: var(--ff-sans);
      font-size: 0.88rem; text-align: center; font-variant-numeric: tabular-nums; width: 100%;
    }

    /* History */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 4px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: var(--shadow); }
    .stat-val { font-family: var(--ff-serif); font-size: 2rem; font-weight: 600; color: var(--accent); line-height: 1; margin-bottom: 4px; }
    .stat-lbl { font-size: 0.75rem; color: var(--muted); font-weight: 500; }
    .history-list { display: flex; flex-direction: column; gap: 8px; }
    .history-item { display: flex; align-items: center; gap: 12px; padding: 13px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow); }
    .h-dot { width: 9px; height: 9px; border-radius: 50%; background: var(--accent); flex-shrink: 0; }
    .h-info { flex: 1; }
    .h-name { font-size: 0.88rem; font-weight: 500; margin-bottom: 2px; }
    .h-date { font-size: 0.72rem; color: var(--muted); }
    .h-dur { font-size: 0.78rem; color: var(--muted); font-variant-numeric: tabular-nums; }
    .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); font-size: 0.88rem; }
    .empty-icon { font-size: 2.2rem; margin-bottom: 10px; }

    /* Completion */
    .completion-card { display: none; flex-direction: column; align-items: center; text-align: center; padding: 32px 20px; }
    .completion-card.visible { display: flex; }
    .completion-emoji { font-size: 3rem; margin-bottom: 14px; }
    .completion-title { font-family: var(--ff-serif); font-size: 1.6rem; font-weight: 600; margin-bottom: 8px; }
    .completion-sub { font-size: 0.85rem; color: var(--muted); margin-bottom: 22px; }

    /* Buttons */
    .btn { width: 100%; padding: 15px; border-radius: 14px; border: none; font-family: var(--ff-sans); font-size: 0.92rem; font-weight: 600; cursor: pointer; transition: transform 0.12s; letter-spacing: 0.01em; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }

    /* Debug */
    .debug-panel { display: none; font-size: 0.72rem; color: var(--muted); border: 1px dashed var(--border); border-radius: 12px; padding: 10px 12px; line-height: 1.8; }
    .debug-panel.visible { display: block; }

    details summary { cursor: pointer; font-size: 0.82rem; font-weight: 500; color: var(--muted); padding: 2px 0; }
    details[open] summary { margin-bottom: 10px; }
    :focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .mt-8 { margin-top: 8px; }
    .section-heading { font-family: var(--ff-serif); font-size: 1.1rem; font-weight: 600; margin-bottom: 12px; }
  </style>
</head>
<body>
<div class="app">

  <div id="updateBanner" role="status" aria-live="polite">
    <span>Update available</span>
    <button id="reloadBtn" class="btn btn-primary" style="width:auto;padding:8px 14px;font-size:0.8rem;">Reload</button>
  </div>

  <header class="header">
    <div class="wordmark">stretch<em>.</em></div>
    <div class="header-right">
      <span class="pill-remaining" id="headerRemaining">‚Äî left</span>
      <button class="icon-btn" id="soundBtn" aria-label="Toggle sound">üîî</button>
      <button class="icon-btn" id="debugBtn" aria-label="Diagnostics">i</button>
    </div>
  </header>

  <nav class="tabs" role="tablist">
    <button class="tab active" role="tab" aria-selected="true"  onclick="showTab('timer')">Timer</button>
    <button class="tab"        role="tab" aria-selected="false" onclick="showTab('routine')">Routine</button>
    <button class="tab"        role="tab" aria-selected="false" onclick="showTab('settings')">Settings</button>
  </nav>

  <!-- ‚ïê‚ïê TIMER ‚ïê‚ïê -->
  <div class="page active" id="timerPage" role="tabpanel">
    <div id="activeTimer">
      <div class="card timer-hero">
        <div class="step-name-display" id="stepNameDisplay">Ready to stretch</div>
        <div class="step-cue-display"  id="stepCueDisplay">Press ‚ñ∂ to begin</div>

        <div class="ring-wrap">
          <svg viewBox="0 0 100 100">
            <circle class="ring-bg" cx="50" cy="50" r="42"/>
            <circle class="ring-fg" id="ringFg" cx="50" cy="50" r="42"/>
          </svg>
          <div class="ring-center">
            <div class="ring-time"  id="ringTime">‚Äî:‚Äî‚Äî</div>
            <div class="ring-phase" id="ringPhase">ready</div>
          </div>
        </div>

        <div class="step-dots" id="stepDots"></div>

        <div class="progress-wrap">
          <div class="progress-meta">
            <span id="stepProgressText">Step ‚Äî of ‚Äî</span>
            <span id="stepProgressPct">0%</span>
          </div>
          <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
        </div>

        <div class="sec-controls">
          <button class="sec-btn" aria-label="Previous" onclick="prevStep()">‚èÆ</button>
          <button class="play-btn" id="playBtn" aria-label="Play/pause" onclick="togglePlay()">‚ñ∂</button>
          <button class="sec-btn" aria-label="Skip" onclick="nextStep(false)">‚è≠</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Routine</div>
        <div class="routine-segmented" id="timerSeg" role="radiogroup">
          <button class="routine-seg-btn" data-key="quick" onclick="switchMode('quick')">Quick<br><span style="font-size:0.72rem;font-weight:400;opacity:0.7">~9 min</span></button>
          <button class="routine-seg-btn active" data-key="long" onclick="switchMode('long')">Full<br><span style="font-size:0.72rem;font-weight:400;opacity:0.7">~17 min</span></button>
        </div>
        <details>
          <summary>Upcoming stretches</summary>
          <ul id="previewList" class="step-list mt-8"></ul>
        </details>
      </div>
    </div>

    <div class="card completion-card" id="completionCard">
      <div class="completion-emoji">üéâ</div>
      <div class="completion-title">Session complete!</div>
      <div class="completion-sub" id="completionSub">Great work.</div>
      <button class="btn btn-primary" onclick="startAgain()">Start Again</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê ROUTINE ‚ïê‚ïê -->
  <div class="page" id="routinePage" role="tabpanel">
    <div class="card">
      <div class="routine-segmented" id="routineSeg" role="radiogroup">
        <button class="routine-seg-btn" data-key="quick" onclick="switchMode('quick')">Quick (~9 min)</button>
        <button class="routine-seg-btn active" data-key="long" onclick="switchMode('long')">Full (~17 min)</button>
      </div>
      <div class="section-heading" id="routineHeading">Full Routine</div>
      <ul class="step-list" id="stepList"></ul>
    </div>
  </div>

  <!-- ‚ïê‚ïê SETTINGS ‚ïê‚ïê -->
  <div class="page" id="settingsPage" role="tabpanel">
    <div class="card">
      <div class="card-title">Appearance</div>
      <div class="setting-row">
        <label class="setting-label" for="themeSelect">Theme</label>
        <select class="setting-select" id="themeSelect">
          <option value="system">System</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Edit Durations (seconds)</div>
      <div class="routine-segmented" id="settingsSeg" role="radiogroup">
        <button class="routine-seg-btn" data-key="quick" onclick="switchMode('quick')">Quick</button>
        <button class="routine-seg-btn active" data-key="long" onclick="switchMode('long')">Full</button>
      </div>
      <div class="dur-editor" id="durEditor"></div>
      <button class="btn btn-secondary mt-8" onclick="resetDurations()" style="margin-top:12px;">Reset to defaults</button>
    </div>
    <div class="card">
      <div class="card-title">History</div>
      <div class="stats-grid" id="statsGrid"></div>
      <div class="history-list mt-8" id="historyList"></div>
    </div>
    <div class="card" style="font-size:0.78rem;color:var(--muted);line-height:1.8;">
      Version: <span id="versionLabel">‚Äî</span>
    </div>
    <div class="debug-panel" id="debugPanel"></div>
  </div>

</div>

<script>
const APP_VERSION = 'v2.0-2026.02.20';
const STORAGE_KEY = 'stretch-timer-settings-vnext';
const HISTORY_KEY = 'stretch-timer-history';
const RING_CIRC   = 263.89;
const REST_SECS   = 12;

const BASE = {
  long: [
    { label: 'Left Half-Kneeling Hip Flexor',  seconds: 75 },
    { label: 'Right Half-Kneeling Hip Flexor', seconds: 75 },
    { label: 'Left Couch Stretch',             seconds: 75 },
    { label: 'Right Couch Stretch',            seconds: 75 },
    { label: 'Left Pigeon Pose',               seconds: 75 },
    { label: 'Right Pigeon Pose',              seconds: 75 },
    { label: 'Left Hamstring Stretch',         seconds: 75 },
    { label: 'Right Hamstring Stretch',        seconds: 75 },
    { label: 'Adductor Rock-Back',             seconds: 60 },
    { label: 'Calf Stretch (Wall)',            seconds: 60 },
    { label: 'Thoracic Opener (Open Book)',    seconds: 60 },
    { label: "Child's Pose",                   seconds: 60 },
    { label: 'Supine Spinal Twist (Left)',     seconds: 60 },
    { label: 'Supine Spinal Twist (Right)',    seconds: 60 },
  ],
  quick: [
    { label: 'Left Half-Kneeling Hip Flexor',  seconds: 60 },
    { label: 'Right Half-Kneeling Hip Flexor', seconds: 60 },
    { label: 'Left Pigeon Pose',               seconds: 60 },
    { label: 'Right Pigeon Pose',              seconds: 60 },
    { label: 'Left Hamstring Stretch',         seconds: 60 },
    { label: 'Right Hamstring Stretch',        seconds: 60 },
    { label: 'Chest Opener (Doorway)',         seconds: 60 },
    { label: 'Thoracic Opener (Open Book)',    seconds: 60 },
    { label: "Child's Pose",                   seconds: 60 },
  ]
};

const S = {
  key: 'long', routines: structuredClone(BASE), durations: {long:[],quick:[]},
  idx: 0, remaining: 0, total: 0,
  running: false, resting: false, ticker: null, endsAt: 0,
  done: false, theme: 'system', sound: true, sessionStart: null,
  sw: false, dbg: false,
};

// ‚îÄ‚îÄ Audio ‚îÄ‚îÄ
let audioCtx = null;
const getCtx = () => audioCtx || (audioCtx = new (window.AudioContext||window.webkitAudioContext)());
function tone(freq, dur, vol=0.22, type='sine') {
  if (!S.sound) return;
  try {
    const ctx=getCtx(), o=ctx.createOscillator(), g=ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type=type; o.frequency.value=freq;
    g.gain.setValueAtTime(vol,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+dur);
    o.start(); o.stop(ctx.currentTime+dur);
  } catch(e){}
}
const chimeStart = () => { tone(523,.25); setTimeout(()=>tone(659,.25),100); setTimeout(()=>tone(784,.4),200); };
const chimeRest  = () => tone(440,.4,'triangle',.18);
const chimeDone  = () => { tone(523,.2); setTimeout(()=>tone(659,.2),90); setTimeout(()=>tone(784,.2),180); setTimeout(()=>tone(1047,.55),270); };
const chimeBeep  = () => tone(880,.12,'square',.08);

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
const cur  = () => S.routines[S.key];
const step = () => cur()[S.idx];
const fmt  = s => { s=Math.max(0,Math.floor(s)); return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; };
const remTotal = () => cur().slice(S.idx+1).reduce((a,s)=>a+s.seconds,0)+S.remaining;
const $  = id => document.getElementById(id);

// ‚îÄ‚îÄ Persist ‚îÄ‚îÄ
function applyDurs(ov) {
  ['long','quick'].forEach(k => {
    const b=BASE[k], src=Array.isArray(ov?.[k])?ov[k]:[];
    S.durations[k]=b.map((s,i)=>{ const v=Number(src[i]); return Number.isFinite(v)?Math.min(600,Math.max(15,Math.round(v))):s.seconds; });
    S.routines[k]=b.map((s,i)=>({...s,seconds:S.durations[k][i]}));
  });
}
function loadSettings() {
  applyDurs(null);
  try {
    const p=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
    if(['system','light','dark'].includes(p.theme)) S.theme=p.theme;
    if(['long','quick'].includes(p.key))            S.key=p.key;
    if(typeof p.sound==='boolean')                  S.sound=p.sound;
    applyDurs(p.durations);
  } catch(e){}
}
function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({theme:S.theme,key:S.key,sound:S.sound,durations:S.durations}));
}
function saveHistory(name,mins,stretches) {
  try {
    const h=JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');
    h.unshift({routine:name,date:new Date().toISOString(),mins,stretches});
    localStorage.setItem(HISTORY_KEY,JSON.stringify(h.slice(0,60)));
  } catch(e){}
}

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
function showTab(name) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>{t.classList.remove('active');t.setAttribute('aria-selected','false');});
  $(`${name}Page`).classList.add('active');
  const tabs=['timer','routine','settings'];
  const t=document.querySelectorAll('.tab')[tabs.indexOf(name)];
  if(t){t.classList.add('active');t.setAttribute('aria-selected','true');}
  if(name==='routine')  buildStepList();
  if(name==='settings') { buildDurEditor(); renderHistory(); }
}

// ‚îÄ‚îÄ Theme ‚îÄ‚îÄ
function applyTheme() {
  const r=document.documentElement;
  if(S.theme==='system') r.removeAttribute('data-theme');
  else r.setAttribute('data-theme',S.theme);
}

// ‚îÄ‚îÄ Sync all segmented controls ‚îÄ‚îÄ
function syncAll() {
  ['timerSeg','routineSeg','settingsSeg'].forEach(id=>{
    const w=$(id); if(!w) return;
    w.querySelectorAll('[data-key]').forEach(b=>b.classList.toggle('active',b.dataset.key===S.key));
  });
  const ts=$('themeSelect'); if(ts) ts.value=S.theme;
  $('soundBtn').textContent=S.sound?'üîî':'üîï';
  $('versionLabel').textContent=APP_VERSION;
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function render() {
  const r=cur(), s=step();
  const elapsed=S.total-S.remaining;
  const frac=S.total?elapsed/S.total:0;
  const pct=Math.round(((S.idx+Math.min(1,Math.max(0,frac)))/r.length)*100);

  // Ring
  const off=RING_CIRC*(1-Math.min(1,Math.max(0,S.remaining/S.total)));
  $('ringFg').style.strokeDashoffset=off;
  $('ringFg').classList.toggle('rest-color',S.resting);
  $('ringTime').textContent=fmt(S.remaining);
  $('ringPhase').textContent=S.done?'done':S.resting?'rest':'stretch';

  // Labels
  if(!S.done){
    $('stepNameDisplay').textContent=S.resting?'Rest':s.label;
    $('stepCueDisplay').textContent=S.resting?`Next: ${r[S.idx+1]?.label||'last one!'}`:`Step ${S.idx+1} of ${r.length}`;
  }

  // Play btn
  const pb=$('playBtn');
  pb.textContent=S.running?'‚è∏':'‚ñ∂';
  pb.classList.toggle('rest-mode',S.resting);

  // Progress
  $('progressFill').style.width=`${pct}%`;
  $('stepProgressText').textContent=`Step ${S.idx+1} of ${r.length}`;
  $('stepProgressPct').textContent=`${pct}%`;
  $('headerRemaining').textContent=`${fmt(remTotal())} left`;

  // Dots
  buildDots();
  buildPreview();

  // Completion
  $('completionCard').classList.toggle('visible',S.done);
  $('activeTimer').style.display=S.done?'none':'';

  applyTheme();
  syncAll();
  if(S.dbg) renderDebug();
}

function buildDots() {
  const r=cur(), c=$('stepDots');
  c.innerHTML='';
  r.forEach((_,i)=>{
    const d=document.createElement('div');
    d.className='dot'+(i<S.idx?' done':i===S.idx&&S.resting?' rest-active':i===S.idx?' active':'');
    d.title=r[i].label;
    d.addEventListener('click',()=>jumpTo(i));
    c.appendChild(d);
  });
}

function buildPreview() {
  const up=cur().slice(S.idx+1,S.idx+4), pl=$('previewList');
  pl.innerHTML='';
  if(!up.length){
    const li=document.createElement('li');
    li.style.cssText='color:var(--muted);font-size:0.8rem;padding:8px 0;list-style:none;';
    li.textContent='No upcoming stretches'; pl.appendChild(li); return;
  }
  up.forEach((s,i)=>{
    const li=document.createElement('li');
    li.innerHTML=`<span class="step-num">${S.idx+2+i}</span><span>${s.label}</span><span class="step-dur">${fmt(s.seconds)}</span>`;
    pl.appendChild(li);
  });
}

function buildStepList() {
  const r=cur(), sl=$('stepList');
  sl.innerHTML='';
  $('routineHeading').textContent=S.key==='long'?'Full Routine':'Quick Routine';
  r.forEach((s,i)=>{
    const li=document.createElement('li');
    li.className=i===S.idx?'active-step':'';
    li.innerHTML=`<span class="step-num">${i+1}</span><span>${s.label}</span><span class="step-dur">${fmt(s.seconds)}</span>`;
    li.addEventListener('click',()=>jumpTo(i));
    sl.appendChild(li);
  });
}

function buildDurEditor() {
  const r=cur(), de=$('durEditor');
  de.innerHTML='';
  r.forEach((s,i)=>{
    const row=document.createElement('div'); row.className='dur-row';
    const lbl=document.createElement('label'); lbl.className='dur-label'; lbl.textContent=s.label; lbl.htmlFor=`d${i}`;
    const inp=document.createElement('input');
    inp.type='number'; inp.min=15; inp.max=600; inp.step=5;
    inp.id=`d${i}`; inp.className='dur-input'; inp.value=s.seconds;
    inp.addEventListener('change',()=>{
      const v=Math.min(600,Math.max(15,Math.round(Number(inp.value)||s.seconds)));
      inp.value=v;
      S.durations[S.key][i]=v; S.routines[S.key][i].seconds=v;
      if(S.idx===i&&!S.resting){ S.remaining=Math.min(S.remaining,v); S.total=v; }
      S.done=false; save(); render();
    });
    row.append(lbl,inp); de.appendChild(row);
  });
}

function renderHistory() {
  try {
    const h=JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');
    const sg=$('statsGrid');
    const sessions=h.length, mins=h.reduce((a,b)=>a+b.mins,0), stretches=h.reduce((a,b)=>a+b.stretches,0);
    const streak=calcStreak(h);
    sg.innerHTML=`
      <div class="stat-card"><div class="stat-val">${sessions}</div><div class="stat-lbl">sessions</div></div>
      <div class="stat-card"><div class="stat-val">${streak}üî•</div><div class="stat-lbl">day streak</div></div>
      <div class="stat-card"><div class="stat-val">${mins}</div><div class="stat-lbl">total mins</div></div>
      <div class="stat-card"><div class="stat-val">${stretches}</div><div class="stat-lbl">stretches</div></div>
    `;
    const hl=$('historyList');
    hl.innerHTML='';
    if(!h.length){
      hl.innerHTML='<div class="empty-state"><div class="empty-icon">üßò</div>Complete a session to see history</div>';
      return;
    }
    h.slice(0,10).forEach(s=>{
      const d=document.createElement('div'); d.className='history-item';
      d.innerHTML=`<div class="h-dot"></div><div class="h-info"><div class="h-name">${s.routine}</div><div class="h-date">${fmtDate(s.date)}</div></div><div class="h-dur">${s.mins} min</div>`;
      hl.appendChild(d);
    });
  } catch(e){}
}

function calcStreak(h) {
  if(!h.length) return 0;
  const days=[...new Set(h.map(s=>s.date.slice(0,10)))].sort().reverse();
  let streak=0, check=new Date(); check.setHours(0,0,0,0);
  for(const d of days){
    const dd=new Date(d), diff=Math.round((check-dd)/86400000);
    if(diff<=1){streak++;check=dd;} else break;
  }
  return streak;
}

function fmtDate(iso) {
  return new Date(iso).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
}

function renderDebug() {
  $('debugPanel').innerHTML=`mode:${S.key} | theme:${S.theme} | sound:${S.sound} | sw:${S.sw}<br>step:${S.idx} | rem:${S.remaining}s | rest:${S.resting} | ver:${APP_VERSION}`;
}

// ‚îÄ‚îÄ Timer logic ‚îÄ‚îÄ
function stopTicker() { clearInterval(S.ticker); S.ticker=null; S.running=false; }

function startTicker() {
  stopTicker(); S.running=true;
  S.endsAt=Date.now()+S.remaining*1000;
  S.ticker=setInterval(()=>{
    const left=Math.max(0,Math.ceil((S.endsAt-Date.now())/1000));
    if(left<=3&&left>0) chimeBeep();
    S.remaining=left; render();
    if(left<=0){ clearInterval(S.ticker); S.ticker=null; onEnd(); }
  },250);
}

function onEnd() {
  if(S.resting){
    chimeStart(); loadStep(S.idx+1); startTicker();
  } else {
    const d=$('stepDots').children[S.idx];
    if(d) d.className='dot done';
    if(S.idx<cur().length-1){ chimeRest(); loadRest(); startTicker(); }
    else { chimeDone(); finish(); }
  }
}

function loadStep(i) {
  S.idx=i; S.resting=false; S.done=false;
  const s=step(); S.remaining=s.seconds; S.total=s.seconds; render();
}
function loadRest() {
  S.resting=true; S.remaining=REST_SECS; S.total=REST_SECS; render();
}
function finish() {
  stopTicker(); S.done=true;
  const mins=Math.max(1,Math.round((Date.now()-(S.sessionStart||Date.now()))/60000));
  $('completionSub').textContent=`You completed ${cur().length} stretches in ~${mins} minute${mins!==1?'s':''}.`;
  saveHistory(S.key==='long'?'Full Routine':'Quick Routine',mins,cur().length);
  render();
}

function togglePlay() {
  if(S.done) return;
  if(S.running){ stopTicker(); render(); }
  else {
    if(!S.sessionStart) S.sessionStart=Date.now();
    getCtx();
    if(S.remaining===S.total&&!S.resting) chimeStart();
    startTicker();
  }
}
function nextStep(auto=true) {
  if(S.done) return; stopTicker();
  if(!S.resting&&S.idx<cur().length-1){ loadRest(); }
  else if(S.resting&&S.idx<cur().length-1){ loadStep(S.idx+1); }
  else { finish(); return; }
  if(S.running||auto) startTicker();
}
function prevStep() {
  stopTicker();
  if(S.resting){ loadStep(S.idx); } else if(S.idx>0){ loadStep(S.idx-1); }
  if(S.running) startTicker();
}
function jumpTo(i) {
  stopTicker(); loadStep(i); S.done=false; render(); showTab('timer');
}
function startAgain() {
  stopTicker(); S.idx=0; S.resting=false; S.done=false; S.sessionStart=null;
  const s=step(); S.remaining=s.seconds; S.total=s.seconds; render();
}
function switchMode(key) {
  if(!['long','quick'].includes(key)||key===S.key) return;
  stopTicker(); S.key=key; S.idx=0; S.resting=false; S.done=false; S.sessionStart=null;
  const s=step(); S.remaining=s.seconds; S.total=s.seconds;
  save(); render(); buildDurEditor(); buildStepList();
}
function resetDurations() {
  applyDurs(null); S.idx=0; S.resting=false; S.done=false;
  const s=step(); S.remaining=s.seconds; S.total=s.seconds;
  save(); render(); buildDurEditor();
}

// ‚îÄ‚îÄ Events ‚îÄ‚îÄ
$('soundBtn').addEventListener('click',()=>{ S.sound=!S.sound; save(); render(); });
$('themeSelect').addEventListener('change',()=>{ S.theme=$('themeSelect').value; save(); applyTheme(); render(); });
$('debugBtn').addEventListener('click',()=>{ S.dbg=!S.dbg; $('debugPanel').classList.toggle('visible',S.dbg); if(S.dbg) renderDebug(); });

let lp=null;
document.querySelector('.wordmark').addEventListener('pointerdown',()=>{ lp=setTimeout(()=>{ S.dbg=!S.dbg; $('debugPanel').classList.toggle('visible',S.dbg); if(S.dbg) renderDebug(); },700); });
['pointerup','pointercancel','pointerleave'].forEach(ev=>document.querySelector('.wordmark').addEventListener(ev,()=>clearTimeout(lp)));

// ‚îÄ‚îÄ Service Worker ‚îÄ‚îÄ
function setupSW() {
  if(!('serviceWorker' in navigator)) return;
  if(location.hostname==='localhost'||location.hostname==='127.0.0.1') return;
  window.addEventListener('load',async()=>{
    try {
      const reg=await navigator.serviceWorker.register('./sw.js');
      S.sw=true;
      const banner=(r)=>{ if(!r?.waiting) return; $('updateBanner').classList.add('visible'); $('reloadBtn').onclick=()=>r.waiting.postMessage({type:'SKIP_WAITING'}); };
      if(reg.waiting) banner(reg);
      reg.addEventListener('updatefound',()=>{ const nw=reg.installing; nw?.addEventListener('statechange',()=>{ if(nw.state==='installed'&&navigator.serviceWorker.controller) banner(reg); }); });
      navigator.serviceWorker.addEventListener('controllerchange',()=>location.reload());
    } catch(e){ S.sw=false; }
  });
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
loadSettings();
setupSW();
const _s=step(); S.remaining=_s.seconds; S.total=_s.seconds;
applyTheme(); render();
</script>
</body>
</html>
