<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Stretch Timer" />
  <title>Stretch Timer</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --bg: #020617;
      --panel: #0f172a;
      --panel-2: #111827;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --accent-strong: #0ea5e9;
      --danger: #f87171;
      --ok: #34d399;
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      min-height: 100dvh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(180deg, #020617 0%, #0b1120 55%, #111827 100%);
      color: var(--text);
      padding: calc(14px + env(safe-area-inset-top)) 14px calc(18px + env(safe-area-inset-bottom));
    }

    .app {
      width: min(760px, 100%);
      margin: 0 auto;
      display: grid;
      gap: 12px;
      align-content: start;
    }

    .card {
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: var(--radius);
      padding: 14px;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.2rem, 4.8vw, 1.8rem);
      line-height: 1.2;
    }

    .row {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .muted { color: var(--muted); }

    .mode-switch {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      appearance: none;
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: var(--text);
      background: var(--panel-2);
      border-radius: 10px;
      padding: 11px 12px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    button:active { transform: scale(0.985); }

    button.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #082f49;
      border-color: rgba(56, 189, 248, 0.85);
    }

    button.ghost.active {
      border-color: var(--accent);
      box-shadow: inset 0 0 0 1px rgba(56, 189, 248, 0.45);
    }

    button.reset { color: #fecaca; border-color: rgba(248, 113, 113, 0.5); }

    .timer {
      margin-top: 10px;
      font-size: clamp(2.4rem, 16vw, 5rem);
      font-variant-numeric: tabular-nums;
      line-height: 1;
      font-weight: 800;
      letter-spacing: 0.02em;
    }

    .current-step {
      margin-top: 8px;
      font-size: clamp(1rem, 4.2vw, 1.3rem);
      line-height: 1.25;
      min-height: 2.5em;
    }

    .progress {
      margin-top: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.28);
      overflow: hidden;
    }

    .progress > span {
      display: block;
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--ok), var(--accent));
      transition: width 0.2s ease;
    }

    .controls {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
    }

    .list {
      margin: 8px 0 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 7px;
    }

    .list li button {
      width: 100%;
      text-align: left;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .list li.active button {
      border-color: var(--accent);
      box-shadow: inset 0 0 0 1px rgba(56, 189, 248, 0.45);
      background: #0c2436;
    }

    .foot {
      margin-top: 10px;
      display: grid;
      gap: 8px;
    }

    label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
      color: var(--muted);
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    @media (max-width: 560px) {
      .controls { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .controls button:nth-child(1),
      .controls button:nth-child(2) { grid-column: span 1; }
      .controls button:nth-child(3) { grid-column: span 1; }
      .controls button:nth-child(4),
      .controls button:nth-child(5) { grid-column: span 1; }
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="card">
      <h1>Stretch Timer</h1>
      <div class="row">
        <div id="status" class="muted">Ready</div>
        <div class="mode-switch" role="group" aria-label="Mode switch">
          <button id="fullModeBtn" type="button" class="ghost active">Full routine</button>
          <button id="quickModeBtn" type="button" class="ghost">Quick mode</button>
        </div>
      </div>

      <div id="timer" class="timer">00:45</div>
      <div id="currentStep" class="current-step">Press Start to begin.</div>
      <div id="totals" class="muted">Remaining total: --:--</div>

      <div class="progress" aria-label="Step progress">
        <span id="progressFill"></span>
      </div>

      <div class="controls">
        <button id="backBtn" type="button">Back</button>
        <button id="startPauseBtn" type="button" class="primary">Start</button>
        <button id="nextBtn" type="button">Next</button>
        <button id="resetBtn" type="button" class="reset">Reset</button>
        <button id="restartStepBtn" type="button">Restart step</button>
      </div>

      <div class="foot">
        <label for="autoAdvanceToggle">
          <input id="autoAdvanceToggle" type="checkbox" checked />
          Auto-advance at end of each step
        </label>
        <label for="vibrateToggle">
          <input id="vibrateToggle" type="checkbox" checked />
          Vibrate on step change
        </label>
      </div>
    </section>

    <section class="card">
      <div class="muted">Routine steps (tap to jump)</div>
      <ul id="stepList" class="list"></ul>
    </section>
  </main>

  <script>
    const STORAGE_KEY = 'stretch-timer-settings-v1';

    const ROUTINES = {
      full: [
        { label: 'Half-Kneeling Hip Flexor — Left', seconds: 60 },
        { label: 'Half-Kneeling Hip Flexor — Right', seconds: 60 },
        { label: 'Couch Stretch — Left', seconds: 60 },
        { label: 'Couch Stretch — Right', seconds: 60 },
        { label: 'Hamstring Stretch — Left', seconds: 45 },
        { label: 'Hamstring Stretch — Right', seconds: 45 },
        { label: 'Figure-4 Glute Stretch — Left', seconds: 45 },
        { label: 'Figure-4 Glute Stretch — Right', seconds: 45 },
        { label: 'Thoracic Open Book — Left', seconds: 40 },
        { label: 'Thoracic Open Book — Right', seconds: 40 }
      ],
      quick: [
        { label: 'Hip Flexor Stretch — Left', seconds: 45 },
        { label: 'Hip Flexor Stretch — Right', seconds: 45 },
        { label: 'Hamstring Stretch — Left', seconds: 35 },
        { label: 'Hamstring Stretch — Right', seconds: 35 },
        { label: 'Thoracic Open Book — Left', seconds: 30 },
        { label: 'Thoracic Open Book — Right', seconds: 30 }
      ]
    };

    const els = {
      timer: document.getElementById('timer'),
      currentStep: document.getElementById('currentStep'),
      totals: document.getElementById('totals'),
      status: document.getElementById('status'),
      progressFill: document.getElementById('progressFill'),
      stepList: document.getElementById('stepList'),
      startPauseBtn: document.getElementById('startPauseBtn'),
      nextBtn: document.getElementById('nextBtn'),
      backBtn: document.getElementById('backBtn'),
      resetBtn: document.getElementById('resetBtn'),
      restartStepBtn: document.getElementById('restartStepBtn'),
      autoAdvanceToggle: document.getElementById('autoAdvanceToggle'),
      vibrateToggle: document.getElementById('vibrateToggle'),
      fullModeBtn: document.getElementById('fullModeBtn'),
      quickModeBtn: document.getElementById('quickModeBtn')
    };

    const state = {
      mode: 'full',
      stepIndex: 0,
      remaining: 0,
      isRunning: false,
      autoAdvance: true,
      vibrate: true,
      ticker: null,
      endsAt: 0
    };

    function formatClock(totalSeconds) {
      const s = Math.max(0, Math.floor(totalSeconds));
      const min = Math.floor(s / 60).toString().padStart(2, '0');
      const sec = (s % 60).toString().padStart(2, '0');
      return `${min}:${sec}`;
    }

    function currentRoutine() {
      return ROUTINES[state.mode];
    }

    function currentStep() {
      return currentRoutine()[state.stepIndex];
    }

    function loadSettings() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed.mode === 'full' || parsed.mode === 'quick') state.mode = parsed.mode;
        if (typeof parsed.autoAdvance === 'boolean') state.autoAdvance = parsed.autoAdvance;
        if (typeof parsed.vibrate === 'boolean') state.vibrate = parsed.vibrate;
      } catch (_) {
        // Ignore invalid settings and continue with defaults.
      }
    }

    function saveSettings() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        mode: state.mode,
        autoAdvance: state.autoAdvance,
        vibrate: state.vibrate
      }));
    }

    function stopTicker() {
      if (state.ticker) {
        clearInterval(state.ticker);
        state.ticker = null;
      }
      state.isRunning = false;
      els.startPauseBtn.textContent = 'Start';
    }

    function buildStepList() {
      const routine = currentRoutine();
      els.stepList.innerHTML = '';
      routine.forEach((step, index) => {
        const li = document.createElement('li');
        if (index === state.stepIndex) li.className = 'active';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.innerHTML = `<span>${index + 1}. ${step.label}</span><span class="muted">${formatClock(step.seconds)}</span>`;
        btn.addEventListener('click', () => {
          state.stepIndex = index;
          state.remaining = currentStep().seconds;
          render();
          if (state.isRunning) {
            startTicker();
          }
        });

        li.appendChild(btn);
        els.stepList.appendChild(li);
      });
    }

    function buzz() {
      if (!state.vibrate) return;
      if (navigator.vibrate) navigator.vibrate(120);
    }

    function remainingTotalSeconds() {
      const routine = currentRoutine();
      return routine.slice(state.stepIndex + 1).reduce((sum, step) => sum + step.seconds, 0) + state.remaining;
    }

    function render() {
      const routine = currentRoutine();
      const step = currentStep();
      const stepElapsed = step.seconds - state.remaining;
      const stepPct = step.seconds ? Math.min(100, (stepElapsed / step.seconds) * 100) : 0;

      els.timer.textContent = formatClock(state.remaining);
      els.currentStep.textContent = `${state.stepIndex + 1}/${routine.length}: ${step.label}`;
      els.totals.textContent = `Remaining total: ${formatClock(remainingTotalSeconds())}`;
      els.progressFill.style.width = `${stepPct}%`;
      els.status.textContent = state.isRunning ? 'Running' : 'Paused';

      els.startPauseBtn.textContent = state.isRunning ? 'Pause' : 'Start';
      els.autoAdvanceToggle.checked = state.autoAdvance;
      els.vibrateToggle.checked = state.vibrate;
      els.fullModeBtn.classList.toggle('active', state.mode === 'full');
      els.quickModeBtn.classList.toggle('active', state.mode === 'quick');
      buildStepList();
    }

    function onStepFinished() {
      buzz();
      if (state.autoAdvance) {
        nextStep(true);
      } else {
        stopTicker();
        state.remaining = currentStep().seconds;
        render();
      }
    }

    function startTicker() {
      const now = Date.now();
      state.endsAt = now + state.remaining * 1000;
      stopTicker();
      state.isRunning = true;
      els.startPauseBtn.textContent = 'Pause';

      state.ticker = setInterval(() => {
        const secondsLeft = Math.max(0, Math.ceil((state.endsAt - Date.now()) / 1000));
        state.remaining = secondsLeft;
        render();

        if (secondsLeft <= 0) {
          onStepFinished();
        }
      }, 200);
    }

    function switchMode(mode) {
      if (state.mode === mode) return;
      state.mode = mode;
      state.stepIndex = 0;
      state.remaining = currentStep().seconds;
      stopTicker();
      saveSettings();
      render();
    }

    function nextStep(fromAuto = false) {
      const routine = currentRoutine();
      if (state.stepIndex < routine.length - 1) {
        state.stepIndex += 1;
        state.remaining = currentStep().seconds;
        if (!fromAuto) buzz();
        render();
        if (state.isRunning || fromAuto) startTicker();
      } else {
        stopTicker();
        state.remaining = currentStep().seconds;
        els.status.textContent = 'Routine complete';
        render();
      }
    }

    function previousStep() {
      if (state.stepIndex > 0) {
        state.stepIndex -= 1;
        state.remaining = currentStep().seconds;
        buzz();
        render();
        if (state.isRunning) startTicker();
      }
    }

    function resetRoutine() {
      stopTicker();
      state.stepIndex = 0;
      state.remaining = currentStep().seconds;
      els.status.textContent = 'Ready';
      render();
    }

    els.startPauseBtn.addEventListener('click', () => {
      if (state.isRunning) {
        stopTicker();
        render();
      } else {
        startTicker();
      }
    });

    els.nextBtn.addEventListener('click', () => nextStep(false));
    els.backBtn.addEventListener('click', previousStep);
    els.resetBtn.addEventListener('click', resetRoutine);
    els.restartStepBtn.addEventListener('click', () => {
      state.remaining = currentStep().seconds;
      render();
      if (state.isRunning) startTicker();
    });

    els.autoAdvanceToggle.addEventListener('change', () => {
      state.autoAdvance = els.autoAdvanceToggle.checked;
      saveSettings();
    });

    els.vibrateToggle.addEventListener('change', () => {
      state.vibrate = els.vibrateToggle.checked;
      saveSettings();
    });

    els.fullModeBtn.addEventListener('click', () => switchMode('full'));
    els.quickModeBtn.addEventListener('click', () => switchMode('quick'));

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
      });
    }

    loadSettings();
    state.remaining = currentStep().seconds;
    render();
  </script>
</body>
</html>
